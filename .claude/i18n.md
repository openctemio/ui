# Internationalization (i18n) Guide

> Comprehensive guide for implementing multi-language support with RTL text direction.

## üåç Supported Locales

```typescript
// src/lib/i18n.ts
export const locales = ["en", "vi", "ar"] as const
export type Locale = (typeof locales)[number]

export const defaultLocale: Locale = "en"

// RTL languages
export const rtlLocales = ["ar", "he", "fa", "ur"] as const
```

## üîÑ Locale Detection Flow

```
1. User Request
   ‚Üì
2. Proxy Runs (Next.js 16 - replaces middleware)
   ‚îú‚îÄ Check cookie "locale"
   ‚îú‚îÄ Fallback to Accept-Language header
   ‚îî‚îÄ Fallback to defaultLocale ("en")
   ‚Üì
3. Set Cookie
   ‚îî‚îÄ response.cookies.set("locale", detectedLocale)
   ‚Üì
4. Inject Header
   ‚îî‚îÄ response.headers.set("x-locale", detectedLocale)
   ‚Üì
5. Server Components Read Header
   ‚îî‚îÄ headers().get("x-locale")
   ‚Üì
6. Root Layout Sets Direction
   ‚îî‚îÄ <html lang={locale} dir={direction}>
```

## üõ†Ô∏è Implementation

### Proxy Configuration (Next.js 16)

> **IMPORTANT**: Next.js 16 replaced `middleware.ts` with `proxy.ts`.
> The function name changes from `middleware()` to `proxy()`.
> Proxy runs on Node.js runtime (not Edge).

```typescript
// proxy.ts (Next.js 16 - replaces middleware.ts)
import { NextRequest, NextResponse } from "next/server"
import { locales, defaultLocale } from "@/lib/i18n"

function getLocale(request: NextRequest): string {
  // 1. Check cookie
  const cookieLocale = request.cookies.get("locale")?.value
  if (cookieLocale && locales.includes(cookieLocale as any)) {
    return cookieLocale
  }

  // 2. Check Accept-Language header
  const acceptLanguage = request.headers.get("accept-language")
  if (acceptLanguage) {
    const browserLocale = acceptLanguage.split(",")[0].split("-")[0]
    if (locales.includes(browserLocale as any)) {
      return browserLocale
    }
  }

  // 3. Fallback to default
  return defaultLocale
}

// Changed from middleware() to proxy() in Next.js 16
export function proxy(request: NextRequest) {
  const locale = getLocale(request)

  const response = NextResponse.next()

  // Set cookie (persistent)
  response.cookies.set("locale", locale, {
    path: "/",
    maxAge: 60 * 60 * 24 * 365, // 1 year
  })

  // Inject header (for this request)
  response.headers.set("x-locale", locale)

  return response
}

export const config = {
  matcher: [
    // Match root path explicitly
    "/",
    // Match all pathnames except static files
    "/((?!api|_next/static|_next/image|favicon.ico).*)",
  ],
}
```

### Root Layout with Direction

```tsx
// src/app/layout.tsx
import { headers } from "next/headers"
import { Providers } from "./providers"

const rtlLocales = ["ar", "he", "fa", "ur"]

export default async function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const headersList = await headers()
  const locale = headersList.get("x-locale") || "en"
  const direction = rtlLocales.includes(locale) ? "rtl" : "ltr"

  return (
    <html lang={locale} dir={direction} suppressHydrationWarning>
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  )
}
```

## üìñ Usage Patterns

### Server Components

```tsx
// Read locale from headers
import { headers } from "next/headers"

export default async function Page() {
  const headersList = await headers()
  const locale = headersList.get("x-locale") || "en"

  // Use locale to fetch localized content
  const content = await getLocalizedContent(locale)

  return <div>{content.title}</div>
}
```

### Client Components

```tsx
// Access via cookies or create a locale context
"use client"

import { useEffect, useState } from "react"

export function LocalizedComponent() {
  const [locale, setLocale] = useState<string>("en")

  useEffect(() => {
    // Read from cookie
    const cookieLocale = document.cookie
      .split("; ")
      .find((row) => row.startsWith("locale="))
      ?.split("=")[1]

    if (cookieLocale) {
      setLocale(cookieLocale)
    }
  }, [])

  return <div>Current locale: {locale}</div>
}
```

### Better: Locale Context (Recommended)

```tsx
// src/context/locale-provider.tsx
"use client"

import { createContext, useContext, useEffect, useState } from "react"

type Locale = "en" | "vi" | "ar"

const LocaleContext = createContext<{
  locale: Locale
  setLocale: (locale: Locale) => void
}>({
  locale: "en",
  setLocale: () => {},
})

export function LocaleProvider({
  children,
  initialLocale,
}: {
  children: React.ReactNode
  initialLocale: Locale
}) {
  const [locale, setLocaleState] = useState<Locale>(initialLocale)

  const setLocale = (newLocale: Locale) => {
    setLocaleState(newLocale)
    // Update cookie
    document.cookie = `locale=${newLocale}; path=/; max-age=31536000`
    // Reload to apply changes
    window.location.reload()
  }

  return (
    <LocaleContext.Provider value={{ locale, setLocale }}>
      {children}
    </LocaleContext.Provider>
  )
}

export const useLocale = () => useContext(LocaleContext)
```

```tsx
// src/app/layout.tsx
import { LocaleProvider } from "@/context/locale-provider"

export default async function RootLayout({ children }) {
  const locale = (await headers()).get("x-locale") as Locale || "en"

  return (
    <html lang={locale}>
      <body>
        <LocaleProvider initialLocale={locale}>
          {children}
        </LocaleProvider>
      </body>
    </html>
  )
}
```

```tsx
// Usage in any client component
"use client"
import { useLocale } from "@/context/locale-provider"

export function LocaleSwitcher() {
  const { locale, setLocale } = useLocale()

  return (
    <select value={locale} onChange={(e) => setLocale(e.target.value as any)}>
      <option value="en">English</option>
      <option value="vi">Ti·∫øng Vi·ªát</option>
      <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
    </select>
  )
}
```

## üîÑ RTL (Right-to-Left) Support

### Automatic Direction Switching

The root layout automatically sets `dir="rtl"` for RTL languages:

```tsx
// Automatic based on locale
<html dir="ltr">  <!-- for en, vi -->
<html dir="rtl">  <!-- for ar, he, fa, ur -->
```

### CSS for RTL Support

```css
/* globals.css */

/* Padding that respects direction */
.p-start-4 {
  padding-inline-start: 1rem;
}

.p-end-4 {
  padding-inline-end: 1rem;
}

/* Margins that respect direction */
.m-start-auto {
  margin-inline-start: auto;
}

.m-end-auto {
  margin-inline-end: auto;
}

/* Tailwind logical properties */
.ps-4 {
  padding-inline-start: 1rem;
}
.pe-4 {
  padding-inline-end: 1rem;
}
.ms-4 {
  margin-inline-start: 1rem;
}
.me-4 {
  margin-inline-end: 1rem;
}
```

### Component RTL Support

```tsx
// ‚úÖ Good - Uses logical properties
<div className="ps-4 pe-8">
  <p>This works in both LTR and RTL</p>
</div>

// ‚ùå Bad - Fixed direction
<div className="pl-4 pr-8">
  <p>This breaks in RTL</p>
</div>

// ‚úÖ Good - Conditional styling
<div className={cn(
  "p-4",
  direction === "rtl" ? "text-right" : "text-left"
)}>
```

### Icons and Directional Elements

```tsx
"use client"
import { ChevronRight, ChevronLeft } from "lucide-react"
import { useDirection } from "@/context/direction-provider"

export function NavigationButton() {
  const { direction } = useDirection()

  return (
    <button>
      Next
      {direction === "rtl" ? <ChevronLeft /> : <ChevronRight />}
    </button>
  )
}
```

## üìù Translation Management

### Dictionary Pattern

```typescript
// src/lib/dictionaries.ts
const dictionaries = {
  en: () => import("@/dictionaries/en.json").then((m) => m.default),
  vi: () => import("@/dictionaries/vi.json").then((m) => m.default),
  ar: () => import("@/dictionaries/ar.json").then((m) => m.default),
}

export const getDictionary = async (locale: Locale) => {
  return dictionaries[locale]()
}
```

```json
// src/dictionaries/en.json
{
  "common": {
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete"
  },
  "auth": {
    "login": "Login",
    "register": "Register",
    "logout": "Logout"
  }
}
```

```json
// src/dictionaries/ar.json
{
  "common": {
    "save": "ÿ≠ŸÅÿ∏",
    "cancel": "ÿ•ŸÑÿ∫ÿßÿ°",
    "delete": "ÿ≠ÿ∞ŸÅ"
  },
  "auth": {
    "login": "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
    "register": "ÿ™ÿ≥ÿ¨ŸäŸÑ",
    "logout": "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨"
  }
}
```

### Usage in Server Components

```tsx
import { headers } from "next/headers"
import { getDictionary } from "@/lib/dictionaries"

export default async function Page() {
  const locale = (await headers()).get("x-locale") || "en"
  const dict = await getDictionary(locale as any)

  return (
    <div>
      <button>{dict.common.save}</button>
      <button>{dict.common.cancel}</button>
    </div>
  )
}
```

### Type-Safe Translations

```typescript
// src/lib/dictionaries.ts
export type Dictionary = {
  common: {
    save: string
    cancel: string
    delete: string
  }
  auth: {
    login: string
    register: string
    logout: string
  }
}

export const getDictionary = async (locale: Locale): Promise<Dictionary> => {
  return dictionaries[locale]()
}
```

## üåê Locale Switcher Component

```tsx
// src/components/locale-switcher.tsx
"use client"

import { useLocale } from "@/context/locale-provider"
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select"

const locales = [
  { value: "en", label: "English", flag: "üá¨üáß" },
  { value: "vi", label: "Ti·∫øng Vi·ªát", flag: "üáªüá≥" },
  { value: "ar", label: "ÿßŸÑÿπÿ±ÿ®Ÿäÿ©", flag: "üá∏üá¶" },
]

export function LocaleSwitcher() {
  const { locale, setLocale } = useLocale()

  return (
    <Select value={locale} onValueChange={(value) => setLocale(value as any)}>
      <SelectTrigger className="w-[180px]">
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        {locales.map((l) => (
          <SelectItem key={l.value} value={l.value}>
            <span className="flex items-center gap-2">
              <span>{l.flag}</span>
              <span>{l.label}</span>
            </span>
          </SelectItem>
        ))}
      </SelectContent>
    </Select>
  )
}
```

## üì± Date & Number Formatting

```tsx
// Locale-aware formatting
export function formatDate(date: Date, locale: string) {
  return new Intl.DateTimeFormat(locale, {
    year: "numeric",
    month: "long",
    day: "numeric",
  }).format(date)
}

export function formatNumber(num: number, locale: string) {
  return new Intl.NumberFormat(locale).format(num)
}

export function formatCurrency(amount: number, locale: string, currency: string) {
  return new Intl.NumberFormat(locale, {
    style: "currency",
    currency,
  }).format(amount)
}

// Usage
const formatted = formatDate(new Date(), "vi")
// "10 th√°ng 12, 2025"

const price = formatCurrency(1234.56, "ar", "SAR")
// "Ÿ°Ÿ¨Ÿ¢Ÿ£Ÿ§Ÿ´Ÿ•Ÿ¶ ÿ±.ÿ≥."
```

## üéØ Best Practices

### 1. Always Use Logical Properties

```css
/* ‚úÖ Good */
padding-inline-start: 1rem;
margin-inline-end: 2rem;

/* ‚ùå Bad */
padding-left: 1rem;
margin-right: 2rem;
```

### 2. Test with RTL

Always test your UI with Arabic locale to ensure RTL works:
- Layout doesn't break
- Icons face correct direction
- Menus open on correct side
- Scrollbars appear on correct side

### 3. Avoid Hardcoded Text

```tsx
// ‚ùå Bad
<button>Save</button>

// ‚úÖ Good
<button>{dict.common.save}</button>
```

### 4. Use Direction Context

```tsx
"use client"
import { createContext, useContext } from "react"

type Direction = "ltr" | "rtl"

const DirectionContext = createContext<Direction>("ltr")

export const useDirection = () => useContext(DirectionContext)
```

### 5. Semantic HTML

```tsx
// ‚úÖ Good - Respects direction automatically
<article>
  <p>Text content</p>
</article>

// Explicit direction when needed
<div dir="auto">
  {userGeneratedContent}
</div>
```

## üêõ Common Issues

### Issue: Content flashes in wrong direction

**Solution:** Use `suppressHydrationWarning` on `<html>`:

```tsx
<html lang={locale} dir={direction} suppressHydrationWarning>
```

### Issue: Icons don't flip in RTL

**Solution:** Use conditional rendering or CSS transform:

```css
[dir="rtl"] .flip-rtl {
  transform: scaleX(-1);
}
```

```tsx
<ChevronRight className="flip-rtl" />
```

### Issue: Layout breaks in RTL

**Solution:** Use Tailwind logical properties or CSS logical properties:

```tsx
// Instead of ml-4, mr-4
<div className="ms-4 me-4">

// Or conditional
<div className={cn(
  "m-4",
  dir === "rtl" ? "mr-auto" : "ml-auto"
)}>
```

## üéì Resources

- [MDN - CSS Logical Properties](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Logical_Properties)
- [Tailwind - Logical Properties](https://tailwindcss.com/docs/padding#logical-properties)
- [W3C - Internationalization](https://www.w3.org/International/)

---

**See also:**
- [patterns.md](patterns.md) - Code patterns
- [architecture.md](architecture.md) - Project structure
