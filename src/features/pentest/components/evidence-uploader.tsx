"use client";

import * as React from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { cn } from "@/lib/utils";
import {
  Upload,
  Image as ImageIcon,
  Video,
  FileText,
  Loader2,
  Eye,
  Download,
  Trash2,
} from "lucide-react";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import type { Evidence } from "../types";

// ============================================
// Evidence Uploader Component
// ============================================

interface EvidenceUploaderProps {
  value: Evidence[];
  onChange: (evidence: Evidence[]) => void;
  accept?: string;
  maxFiles?: number;
  maxSize?: number; // in MB
  type?: "image" | "video" | "any";
  className?: string;
}

export function EvidenceUploader({
  value,
  onChange,
  accept,
  maxFiles = 10,
  maxSize = 50, // 50MB default
  type = "any",
  className,
}: EvidenceUploaderProps) {
  const [isDragging, setIsDragging] = React.useState(false);
  const [isUploading, setIsUploading] = React.useState(false);
  const inputRef = React.useRef<HTMLInputElement>(null);

  const acceptTypes = accept || (type === "image"
    ? "image/*"
    : type === "video"
    ? "video/*"
    : "image/*,video/*");

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(true);
  };

  const handleDragLeave = (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);
  };

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault();
    setIsDragging(false);
    const files = Array.from(e.dataTransfer.files);
    handleFiles(files);
  };

  const handleFiles = async (files: File[]) => {
    if (value.length + files.length > maxFiles) {
      alert(`Maximum ${maxFiles} files allowed`);
      return;
    }

    setIsUploading(true);

    const newEvidence: Evidence[] = [];

    for (const file of files) {
      // Check file size
      if (file.size > maxSize * 1024 * 1024) {
        alert(`File ${file.name} exceeds ${maxSize}MB limit`);
        continue;
      }

      // In a real app, this would upload to a server/cloud storage
      // For demo, we create a local URL
      const url = URL.createObjectURL(file);
      const fileType = file.type.startsWith("image/") ? "image" : "video";

      newEvidence.push({
        id: `evidence-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        type: fileType as "image" | "video",
        url,
        name: file.name,
        mimeType: file.type,
        size: file.size,
        description: "",
        createdAt: new Date().toISOString(),
      });
    }

    onChange([...value, ...newEvidence]);
    setIsUploading(false);
  };

  const handleFileInput = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      handleFiles(Array.from(e.target.files));
    }
  };

  const removeEvidence = (id: string) => {
    onChange(value.filter((e) => e.id !== id));
  };

  const updateDescription = (id: string, description: string) => {
    onChange(
      value.map((e) => (e.id === id ? { ...e, description } : e))
    );
  };

  return (
    <div className={cn("space-y-4", className)}>
      {/* Upload Zone */}
      <div
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        onDrop={handleDrop}
        onClick={() => inputRef.current?.click()}
        className={cn(
          "border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors",
          isDragging
            ? "border-primary bg-primary/5"
            : "border-muted-foreground/25 hover:border-primary/50",
          isUploading && "pointer-events-none opacity-50"
        )}
      >
        <input
          ref={inputRef}
          type="file"
          accept={acceptTypes}
          multiple
          onChange={handleFileInput}
          className="hidden"
        />

        {isUploading ? (
          <div className="flex flex-col items-center gap-2">
            <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
            <p className="text-sm text-muted-foreground">Uploading...</p>
          </div>
        ) : (
          <div className="flex flex-col items-center gap-2">
            <Upload className="h-8 w-8 text-muted-foreground" />
            <p className="text-sm font-medium">
              Drop files here or click to upload
            </p>
            <p className="text-xs text-muted-foreground">
              {type === "image" && "Images only (PNG, JPG, GIF)"}
              {type === "video" && "Videos only (MP4, WebM)"}
              {type === "any" && "Images and videos supported"}
              {" - Max {maxSize}MB per file"}
            </p>
          </div>
        )}
      </div>

      {/* Evidence List */}
      {value.length > 0 && (
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {value.map((evidence) => (
            <EvidenceCard
              key={evidence.id}
              evidence={evidence}
              onRemove={() => removeEvidence(evidence.id)}
              onDescriptionChange={(description) => updateDescription(evidence.id, description)}
            />
          ))}
        </div>
      )}
    </div>
  );
}

// ============================================
// Evidence Card Component
// ============================================

interface EvidenceCardProps {
  evidence: Evidence;
  onRemove: () => void;
  onDescriptionChange?: (description: string) => void;
  readOnly?: boolean;
}

function EvidenceCard({
  evidence,
  onRemove,
  onDescriptionChange,
  readOnly = false,
}: EvidenceCardProps) {
  const [previewOpen, setPreviewOpen] = React.useState(false);

  return (
    <>
      <Card className="overflow-hidden group">
        <div className="relative aspect-video bg-muted">
          {evidence.type === "image" ? (
            // eslint-disable-next-line @next/next/no-img-element
            <img
              src={evidence.url}
              alt={evidence.description || evidence.name}
              className="w-full h-full object-cover"
            />
          ) : (
            <div className="w-full h-full flex items-center justify-center">
              <Video className="h-12 w-12 text-muted-foreground" />
            </div>
          )}

          {/* Overlay Actions */}
          <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
            <Button
              size="icon"
              variant="secondary"
              className="h-8 w-8"
              onClick={() => setPreviewOpen(true)}
            >
              <Eye className="h-4 w-4" />
            </Button>
            <Button
              size="icon"
              variant="secondary"
              className="h-8 w-8"
              asChild
            >
              <a href={evidence.url} download={evidence.name}>
                <Download className="h-4 w-4" />
              </a>
            </Button>
            {!readOnly && (
              <Button
                size="icon"
                variant="destructive"
                className="h-8 w-8"
                onClick={onRemove}
              >
                <Trash2 className="h-4 w-4" />
              </Button>
            )}
          </div>

          {/* Type Badge */}
          <div className="absolute top-2 left-2">
            <div className="bg-black/60 text-white text-xs px-2 py-1 rounded flex items-center gap-1">
              {evidence.type === "image" ? (
                <ImageIcon className="h-3 w-3" />
              ) : (
                <Video className="h-3 w-3" />
              )}
              {evidence.type}
            </div>
          </div>
        </div>

        <CardContent className="p-2">
          <p className="text-xs text-muted-foreground truncate" title={evidence.name}>
            {evidence.name}
          </p>
          {!readOnly && onDescriptionChange && (
            <Input
              placeholder="Add description..."
              value={evidence.description || ""}
              onChange={(e) => onDescriptionChange(e.target.value)}
              className="mt-2 h-7 text-xs"
            />
          )}
          {readOnly && evidence.description && (
            <p className="text-xs mt-1">{evidence.description}</p>
          )}
        </CardContent>
      </Card>

      {/* Preview Dialog */}
      <Dialog open={previewOpen} onOpenChange={setPreviewOpen}>
        <DialogContent className="max-w-4xl max-h-[90vh]">
          <DialogHeader>
            <DialogTitle>{evidence.name}</DialogTitle>
          </DialogHeader>
          <div className="flex items-center justify-center">
            {evidence.type === "image" ? (
              // eslint-disable-next-line @next/next/no-img-element
              <img
                src={evidence.url}
                alt={evidence.description || evidence.name}
                className="max-w-full max-h-[70vh] object-contain"
              />
            ) : (
              <video
                src={evidence.url}
                controls
                className="max-w-full max-h-[70vh]"
              >
                Your browser does not support the video tag.
              </video>
            )}
          </div>
          {evidence.description && (
            <p className="text-sm text-muted-foreground text-center">
              {evidence.description}
            </p>
          )}
        </DialogContent>
      </Dialog>
    </>
  );
}

// ============================================
// Evidence Gallery Component (Read-only display)
// ============================================

interface EvidenceGalleryProps {
  images?: Evidence[];
  videos?: Evidence[];
  className?: string;
}

export function EvidenceGallery({
  images = [],
  videos = [],
  className,
}: EvidenceGalleryProps) {
  const allEvidence = [...images, ...videos];

  if (allEvidence.length === 0) {
    return (
      <div className={cn("text-center py-8 text-muted-foreground", className)}>
        <FileText className="h-12 w-12 mx-auto mb-2 opacity-50" />
        <p>No evidence uploaded</p>
      </div>
    );
  }

  return (
    <div className={cn("grid grid-cols-2 md:grid-cols-3 gap-4", className)}>
      {allEvidence.map((evidence) => (
        <EvidenceCard
          key={evidence.id}
          evidence={evidence}
          onRemove={() => {}}
          readOnly
        />
      ))}
    </div>
  );
}

// ============================================
// Request/Response Viewer Component
// ============================================

interface RequestResponseViewerProps {
  requestResponses: Array<{
    request: string;
    response: string;
    description?: string;
  }>;
  className?: string;
}

export function RequestResponseViewer({
  requestResponses,
  className,
}: RequestResponseViewerProps) {
  const [selectedIndex, setSelectedIndex] = React.useState(0);

  if (requestResponses.length === 0) {
    return (
      <div className={cn("text-center py-8 text-muted-foreground", className)}>
        <FileText className="h-12 w-12 mx-auto mb-2 opacity-50" />
        <p>No request/response captured</p>
      </div>
    );
  }

  const current = requestResponses[selectedIndex];

  return (
    <div className={cn("space-y-4", className)}>
      {/* Tabs for multiple requests */}
      {requestResponses.length > 1 && (
        <div className="flex gap-2 overflow-x-auto pb-2">
          {requestResponses.map((_, index) => (
            <Button
              key={index}
              variant={selectedIndex === index ? "default" : "outline"}
              size="sm"
              onClick={() => setSelectedIndex(index)}
            >
              Request #{index + 1}
            </Button>
          ))}
        </div>
      )}

      {/* Description */}
      {current.description && (
        <p className="text-sm text-muted-foreground">{current.description}</p>
      )}

      {/* Request/Response Display */}
      <div className="grid md:grid-cols-2 gap-4">
        <div>
          <Label className="text-xs font-medium mb-2 block">Request</Label>
          <pre className="bg-muted p-4 rounded-lg text-xs overflow-x-auto max-h-[400px] overflow-y-auto">
            {current.request}
          </pre>
        </div>
        <div>
          <Label className="text-xs font-medium mb-2 block">Response</Label>
          <pre className="bg-muted p-4 rounded-lg text-xs overflow-x-auto max-h-[400px] overflow-y-auto">
            {current.response}
          </pre>
        </div>
      </div>
    </div>
  );
}

// ============================================
// PoC Code Editor Component
// ============================================

interface PocCodeEditorProps {
  value: string;
  onChange: (value: string) => void;
  language?: string;
  className?: string;
}

export function PocCodeEditor({
  value,
  onChange,
  language = "python",
  className,
}: PocCodeEditorProps) {
  return (
    <div className={cn("space-y-2", className)}>
      <div className="flex items-center justify-between">
        <Label className="text-sm font-medium">Proof of Concept Code</Label>
        <select
          value={language}
          className="text-xs border rounded px-2 py-1 bg-background"
          disabled
        >
          <option value="python">Python</option>
          <option value="bash">Bash</option>
          <option value="javascript">JavaScript</option>
          <option value="curl">cURL</option>
        </select>
      </div>
      <textarea
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder="# Enter your PoC code here...&#10;import requests&#10;&#10;url = 'https://target.com/api/vulnerable'&#10;payload = {'id': '1 OR 1=1'}&#10;response = requests.get(url, params=payload)&#10;print(response.text)"
        className={cn(
          "w-full min-h-[300px] p-4 font-mono text-sm",
          "bg-slate-900 text-slate-100 rounded-lg",
          "focus:outline-none focus:ring-2 focus:ring-primary",
          "resize-y"
        )}
        spellCheck={false}
      />
    </div>
  );
}
