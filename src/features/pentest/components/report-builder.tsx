"use client";

import * as React from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Progress } from "@/components/ui/progress";
import { cn } from "@/lib/utils";
import {
  FileText,
  FileType,
  FileSpreadsheet,
  Code,
  Braces,
  Download,
  Loader2,
  CheckCircle2,
  XCircle,
  Clock,
  BarChart3,
  Shield,
  ClipboardList,
  AlertTriangle,
  RotateCcw,
  Eye,
} from "lucide-react";
import type {
  ReportType,
  ReportFormat,
  ReportOptions,
  PentestCampaign,
  PentestReport,
  FindingSeverity,
  FindingStatus,
} from "../types";
import {
  REPORT_TYPE_LABELS,
  REPORT_TYPE_DESCRIPTIONS,
  REPORT_FORMAT_LABELS,
  FINDING_SEVERITY_LABELS,
  FINDING_STATUS_LABELS,
} from "../types";

// ============================================
// Report Type Selector
// ============================================

interface ReportTypeSelectorProps {
  value: ReportType;
  onChange: (type: ReportType) => void;
}

const reportTypeIcons: Record<ReportType, React.ReactNode> = {
  executive_summary: <BarChart3 className="h-5 w-5" />,
  technical_report: <FileText className="h-5 w-5" />,
  finding_report: <AlertTriangle className="h-5 w-5" />,
  compliance_report: <Shield className="h-5 w-5" />,
  remediation_report: <ClipboardList className="h-5 w-5" />,
  retest_report: <RotateCcw className="h-5 w-5" />,
};

export function ReportTypeSelector({ value, onChange }: ReportTypeSelectorProps) {
  const reportTypes: ReportType[] = [
    "executive_summary",
    "technical_report",
    "finding_report",
    "compliance_report",
    "remediation_report",
    "retest_report",
  ];

  return (
    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
      {reportTypes.map((type) => (
        <Card
          key={type}
          className={cn(
            "cursor-pointer transition-all hover:border-primary/50",
            value === type && "border-primary ring-2 ring-primary/20"
          )}
          onClick={() => onChange(type)}
        >
          <CardContent className="p-4">
            <div className="flex items-start gap-3">
              <div
                className={cn(
                  "p-2 rounded-lg",
                  value === type
                    ? "bg-primary text-primary-foreground"
                    : "bg-muted text-muted-foreground"
                )}
              >
                {reportTypeIcons[type]}
              </div>
              <div className="flex-1 min-w-0">
                <p className="font-medium text-sm">{REPORT_TYPE_LABELS[type]}</p>
                <p className="text-xs text-muted-foreground mt-1 line-clamp-2">
                  {REPORT_TYPE_DESCRIPTIONS[type]}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}

// ============================================
// Report Format Selector
// ============================================

interface ReportFormatSelectorProps {
  value: ReportFormat;
  onChange: (format: ReportFormat) => void;
}

const formatIcons: Record<ReportFormat, React.ReactNode> = {
  pdf: <FileText className="h-4 w-4" />,
  docx: <FileType className="h-4 w-4" />,
  xlsx: <FileSpreadsheet className="h-4 w-4" />,
  html: <Code className="h-4 w-4" />,
  json: <Braces className="h-4 w-4" />,
};

export function ReportFormatSelector({ value, onChange }: ReportFormatSelectorProps) {
  const formats: ReportFormat[] = ["pdf", "docx", "xlsx", "html", "json"];

  return (
    <RadioGroup
      value={value}
      onValueChange={(v) => onChange(v as ReportFormat)}
      className="flex flex-wrap gap-2"
    >
      {formats.map((format) => (
        <Label
          key={format}
          className={cn(
            "flex items-center gap-2 px-4 py-2 rounded-lg border cursor-pointer transition-all",
            value === format
              ? "border-primary bg-primary/5"
              : "border-border hover:border-primary/50"
          )}
        >
          <RadioGroupItem value={format} className="sr-only" />
          {formatIcons[format]}
          <span className="text-sm">{REPORT_FORMAT_LABELS[format]}</span>
        </Label>
      ))}
    </RadioGroup>
  );
}

// ============================================
// Report Options Form
// ============================================

interface ReportOptionsFormProps {
  options: ReportOptions;
  onChange: (options: ReportOptions) => void;
  reportType?: ReportType;
}

export function ReportOptionsForm({ options, onChange }: ReportOptionsFormProps) {
  const updateOption = <K extends keyof ReportOptions>(key: K, value: ReportOptions[K]) => {
    onChange({ ...options, [key]: value });
  };

  const toggleSeverity = (severity: FindingSeverity) => {
    const current = options.severityFilter;
    const updated = current.includes(severity)
      ? current.filter((s) => s !== severity)
      : [...current, severity];
    updateOption("severityFilter", updated);
  };

  const toggleStatus = (status: FindingStatus) => {
    const current = options.statusFilter;
    const updated = current.includes(status)
      ? current.filter((s) => s !== status)
      : [...current, status];
    updateOption("statusFilter", updated);
  };

  return (
    <div className="space-y-6">
      {/* Content Sections */}
      <div>
        <Label className="text-sm font-medium mb-3 block">Include Sections</Label>
        <div className="grid grid-cols-2 gap-3">
          <div className="flex items-center space-x-2">
            <Checkbox
              id="executiveSummary"
              checked={options.includeExecutiveSummary}
              onCheckedChange={(checked) => updateOption("includeExecutiveSummary", !!checked)}
            />
            <Label htmlFor="executiveSummary" className="text-sm cursor-pointer">
              Executive Summary
            </Label>
          </div>
          <div className="flex items-center space-x-2">
            <Checkbox
              id="findings"
              checked={options.includeFindings}
              onCheckedChange={(checked) => updateOption("includeFindings", !!checked)}
            />
            <Label htmlFor="findings" className="text-sm cursor-pointer">
              Findings Details
            </Label>
          </div>
          <div className="flex items-center space-x-2">
            <Checkbox
              id="poc"
              checked={options.includePoc}
              onCheckedChange={(checked) => updateOption("includePoc", !!checked)}
            />
            <Label htmlFor="poc" className="text-sm cursor-pointer">
              Proof of Concept
            </Label>
          </div>
          <div className="flex items-center space-x-2">
            <Checkbox
              id="evidence"
              checked={options.includeEvidence}
              onCheckedChange={(checked) => updateOption("includeEvidence", !!checked)}
            />
            <Label htmlFor="evidence" className="text-sm cursor-pointer">
              Evidence/Screenshots
            </Label>
          </div>
          <div className="flex items-center space-x-2">
            <Checkbox
              id="remediation"
              checked={options.includeRemediation}
              onCheckedChange={(checked) => updateOption("includeRemediation", !!checked)}
            />
            <Label htmlFor="remediation" className="text-sm cursor-pointer">
              Remediation Steps
            </Label>
          </div>
          <div className="flex items-center space-x-2">
            <Checkbox
              id="timeline"
              checked={options.includeTimeline}
              onCheckedChange={(checked) => updateOption("includeTimeline", !!checked)}
            />
            <Label htmlFor="timeline" className="text-sm cursor-pointer">
              Timeline/History
            </Label>
          </div>
          <div className="flex items-center space-x-2">
            <Checkbox
              id="appendix"
              checked={options.includeAppendix}
              onCheckedChange={(checked) => updateOption("includeAppendix", !!checked)}
            />
            <Label htmlFor="appendix" className="text-sm cursor-pointer">
              Appendix
            </Label>
          </div>
        </div>
      </div>

      <Separator />

      {/* Severity Filter */}
      <div>
        <Label className="text-sm font-medium mb-3 block">Filter by Severity</Label>
        <div className="flex flex-wrap gap-2">
          {(Object.keys(FINDING_SEVERITY_LABELS) as FindingSeverity[]).map((severity) => (
            <Badge
              key={severity}
              variant={options.severityFilter.includes(severity) ? "default" : "outline"}
              className="cursor-pointer"
              onClick={() => toggleSeverity(severity)}
            >
              {FINDING_SEVERITY_LABELS[severity]}
            </Badge>
          ))}
        </div>
      </div>

      {/* Status Filter */}
      <div>
        <Label className="text-sm font-medium mb-3 block">Filter by Status</Label>
        <div className="flex flex-wrap gap-2">
          {(Object.keys(FINDING_STATUS_LABELS) as FindingStatus[]).map((status) => (
            <Badge
              key={status}
              variant={options.statusFilter.includes(status) ? "default" : "outline"}
              className="cursor-pointer"
              onClick={() => toggleStatus(status)}
            >
              {FINDING_STATUS_LABELS[status]}
            </Badge>
          ))}
        </div>
      </div>

      <Separator />

      {/* Classification */}
      <div>
        <Label className="text-sm font-medium mb-3 block">Document Classification</Label>
        <Select
          value={options.classification || "internal"}
          onValueChange={(v) =>
            updateOption("classification", v as "public" | "internal" | "confidential" | "restricted")
          }
        >
          <SelectTrigger className="w-full max-w-xs">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="public">Public</SelectItem>
            <SelectItem value="internal">Internal Use Only</SelectItem>
            <SelectItem value="confidential">Confidential</SelectItem>
            <SelectItem value="restricted">Restricted</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Watermark */}
      <div>
        <Label htmlFor="watermark" className="text-sm font-medium mb-2 block">
          Watermark Text (optional)
        </Label>
        <Input
          id="watermark"
          placeholder="e.g., DRAFT, CONFIDENTIAL"
          value={options.watermark || ""}
          onChange={(e) => updateOption("watermark", e.target.value)}
          className="max-w-xs"
        />
      </div>
    </div>
  );
}

// ============================================
// Report Generator Dialog
// ============================================

interface ReportGeneratorDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  campaign: PentestCampaign | null;
  onGenerate: (report: Partial<PentestReport>) => void;
}

export function ReportGeneratorDialog({
  open,
  onOpenChange,
  campaign,
  onGenerate,
}: ReportGeneratorDialogProps) {
  const [step, setStep] = React.useState<"type" | "options" | "generating" | "complete">("type");
  const [reportType, setReportType] = React.useState<ReportType>("executive_summary");
  const [reportFormat, setReportFormat] = React.useState<ReportFormat>("pdf");
  const [reportName, setReportName] = React.useState("");
  const [progress, setProgress] = React.useState(0);
  const [options, setOptions] = React.useState<ReportOptions>({
    includeExecutiveSummary: true,
    includeFindings: true,
    includePoc: true,
    includeEvidence: true,
    includeRemediation: true,
    includeTimeline: false,
    includeAppendix: false,
    severityFilter: ["critical", "high", "medium", "low", "info"],
    statusFilter: ["confirmed", "remediation", "retest", "verified"],
    customSections: [],
    classification: "internal",
  });

  React.useEffect(() => {
    if (open && campaign) {
      setReportName(`${campaign.name} - ${REPORT_TYPE_LABELS[reportType]}`);
    }
  }, [open, campaign, reportType]);

  React.useEffect(() => {
    if (step === "generating") {
      // Simulate report generation progress
      const interval = setInterval(() => {
        setProgress((prev) => {
          if (prev >= 100) {
            clearInterval(interval);
            setStep("complete");
            return 100;
          }
          return prev + Math.random() * 15;
        });
      }, 500);

      return () => clearInterval(interval);
    }
  }, [step]);

  const handleGenerate = () => {
    if (!campaign) return;

    setStep("generating");
    setProgress(0);

    // Create report object
    const report: Partial<PentestReport> = {
      campaignId: campaign.id,
      type: reportType,
      format: reportFormat,
      name: reportName,
      options,
      status: "generating",
      createdAt: new Date().toISOString(),
      createdBy: "current-user",
    };

    // Simulate generation complete
    setTimeout(() => {
      onGenerate({
        ...report,
        status: "completed",
        generatedAt: new Date().toISOString(),
        downloadUrl: `/reports/${report.campaignId}-${Date.now()}.${reportFormat}`,
        fileSize: Math.floor(Math.random() * 5000000) + 500000,
      });
    }, 3500);
  };

  const handleClose = () => {
    onOpenChange(false);
    // Reset state after close animation
    setTimeout(() => {
      setStep("type");
      setProgress(0);
    }, 300);
  };

  if (!campaign) return null;

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="max-w-3xl max-h-[90vh]">
        <DialogHeader>
          <DialogTitle>Generate Report</DialogTitle>
          <DialogDescription>
            Create a report for campaign: {campaign.name}
          </DialogDescription>
        </DialogHeader>

        <ScrollArea className="max-h-[60vh]">
          <div className="p-1">
            {step === "type" && (
              <div className="space-y-6">
                {/* Report Name */}
                <div>
                  <Label htmlFor="reportName" className="text-sm font-medium mb-2 block">
                    Report Name
                  </Label>
                  <Input
                    id="reportName"
                    value={reportName}
                    onChange={(e) => setReportName(e.target.value)}
                    placeholder="Enter report name"
                  />
                </div>

                {/* Report Type Selection */}
                <div>
                  <Label className="text-sm font-medium mb-3 block">Report Type</Label>
                  <ReportTypeSelector value={reportType} onChange={setReportType} />
                </div>

                {/* Format Selection */}
                <div>
                  <Label className="text-sm font-medium mb-3 block">Export Format</Label>
                  <ReportFormatSelector value={reportFormat} onChange={setReportFormat} />
                </div>
              </div>
            )}

            {step === "options" && (
              <ReportOptionsForm
                options={options}
                onChange={setOptions}
                reportType={reportType}
              />
            )}

            {step === "generating" && (
              <div className="py-12 text-center">
                <Loader2 className="h-12 w-12 animate-spin mx-auto text-primary mb-4" />
                <h3 className="text-lg font-medium mb-2">Generating Report</h3>
                <p className="text-sm text-muted-foreground mb-6">
                  Please wait while we compile your report...
                </p>
                <div className="max-w-md mx-auto">
                  <Progress value={progress} className="h-2" />
                  <p className="text-xs text-muted-foreground mt-2">
                    {Math.round(progress)}% complete
                  </p>
                </div>
              </div>
            )}

            {step === "complete" && (
              <div className="py-12 text-center">
                <CheckCircle2 className="h-12 w-12 mx-auto text-green-500 mb-4" />
                <h3 className="text-lg font-medium mb-2">Report Generated Successfully</h3>
                <p className="text-sm text-muted-foreground mb-6">
                  Your report is ready for download.
                </p>
                <div className="flex justify-center gap-3">
                  <Button variant="outline" onClick={handleClose}>
                    Close
                  </Button>
                  <Button>
                    <Download className="h-4 w-4 mr-2" />
                    Download Report
                  </Button>
                </div>
              </div>
            )}
          </div>
        </ScrollArea>

        {(step === "type" || step === "options") && (
          <DialogFooter>
            {step === "options" && (
              <Button variant="outline" onClick={() => setStep("type")}>
                Back
              </Button>
            )}
            <Button
              onClick={() => {
                if (step === "type") {
                  setStep("options");
                } else {
                  handleGenerate();
                }
              }}
            >
              {step === "type" ? "Configure Options" : "Generate Report"}
            </Button>
          </DialogFooter>
        )}
      </DialogContent>
    </Dialog>
  );
}

// ============================================
// Report Card Component
// ============================================

interface ReportCardProps {
  report: PentestReport;
  onView: () => void;
  onDownload: () => void;
  onDelete?: () => void;
}

export function ReportCard({ report, onView, onDownload }: ReportCardProps) {
  const statusIcon = {
    draft: <Clock className="h-4 w-4 text-muted-foreground" />,
    generating: <Loader2 className="h-4 w-4 animate-spin text-blue-500" />,
    completed: <CheckCircle2 className="h-4 w-4 text-green-500" />,
    failed: <XCircle className="h-4 w-4 text-red-500" />,
  };

  const formatSize = (bytes?: number) => {
    if (!bytes) return "-";
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  };

  return (
    <Card className="hover:shadow-md transition-shadow">
      <CardContent className="p-4">
        <div className="flex items-start gap-4">
          <div className="p-3 rounded-lg bg-muted">
            {formatIcons[report.format]}
          </div>
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 mb-1">
              <h4 className="font-medium text-sm truncate">{report.name}</h4>
              {statusIcon[report.status]}
            </div>
            <div className="flex items-center gap-2 text-xs text-muted-foreground">
              <Badge variant="outline" className="text-xs">
                {REPORT_TYPE_LABELS[report.type]}
              </Badge>
              <span>{REPORT_FORMAT_LABELS[report.format]}</span>
              <span>{formatSize(report.fileSize)}</span>
            </div>
            {report.generatedAt && (
              <p className="text-xs text-muted-foreground mt-1">
                Generated: {new Date(report.generatedAt).toLocaleString()}
              </p>
            )}
          </div>
          <div className="flex gap-1">
            {report.status === "completed" && (
              <>
                <Button size="icon" variant="ghost" className="h-8 w-8" onClick={onView}>
                  <Eye className="h-4 w-4" />
                </Button>
                <Button size="icon" variant="ghost" className="h-8 w-8" onClick={onDownload}>
                  <Download className="h-4 w-4" />
                </Button>
              </>
            )}
          </div>
        </div>
        {report.status === "failed" && report.error && (
          <p className="text-xs text-red-500 mt-2">{report.error}</p>
        )}
      </CardContent>
    </Card>
  );
}

// ============================================
// Quick Export Dropdown
// ============================================

interface QuickExportButtonProps {
  campaign: PentestCampaign;
  onExport: (format: ReportFormat, type: ReportType) => void;
}

export function QuickExportButton({ campaign: _campaign, onExport }: QuickExportButtonProps) {
  return (
    <Select
      onValueChange={(value) => {
        const [format, type] = value.split(":") as [ReportFormat, ReportType];
        onExport(format, type);
      }}
    >
      <SelectTrigger className="w-[180px]">
        <div className="flex items-center gap-2">
          <Download className="h-4 w-4" />
          <span>Quick Export</span>
        </div>
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="pdf:executive_summary">
          <div className="flex items-center gap-2">
            <FileText className="h-4 w-4" />
            Executive Summary (PDF)
          </div>
        </SelectItem>
        <SelectItem value="pdf:technical_report">
          <div className="flex items-center gap-2">
            <FileText className="h-4 w-4" />
            Technical Report (PDF)
          </div>
        </SelectItem>
        <SelectItem value="xlsx:finding_report">
          <div className="flex items-center gap-2">
            <FileSpreadsheet className="h-4 w-4" />
            Findings Export (Excel)
          </div>
        </SelectItem>
        <SelectItem value="json:technical_report">
          <div className="flex items-center gap-2">
            <Braces className="h-4 w-4" />
            Full Data (JSON)
          </div>
        </SelectItem>
      </SelectContent>
    </Select>
  );
}
