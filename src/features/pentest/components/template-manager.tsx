"use client";

import * as React from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetTitle,
} from "@/components/ui/sheet";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Separator } from "@/components/ui/separator";
import { cn } from "@/lib/utils";
import {
  Plus,
  Search,
  Copy,
  Edit2,
  Trash2,
  FileText,
  Syringe,
  Key,
  Shield,
  Lock,
  Settings,
  Eye,
  Clock,
  FormInput,
  GitBranch,
  FileQuestion,
  ExternalLink,
  Check,
  X,
  Star,
  BookTemplate,
} from "lucide-react";
import type {
  FindingTemplate,
  TemplateCategory,
  FindingSeverity,
  OwaspCategory,
} from "../types";
import {
  TEMPLATE_CATEGORY_LABELS,
  FINDING_SEVERITY_LABELS,
  FINDING_SEVERITY_COLORS,
  OWASP_CATEGORY_LABELS,
} from "../types";

// ============================================
// Category Icons Mapping
// ============================================

const categoryIcons: Record<TemplateCategory, React.ReactNode> = {
  injection: <Syringe className="h-4 w-4" />,
  authentication: <Key className="h-4 w-4" />,
  authorization: <Shield className="h-4 w-4" />,
  cryptographic: <Lock className="h-4 w-4" />,
  configuration: <Settings className="h-4 w-4" />,
  disclosure: <Eye className="h-4 w-4" />,
  session: <Clock className="h-4 w-4" />,
  input_validation: <FormInput className="h-4 w-4" />,
  logic: <GitBranch className="h-4 w-4" />,
  other: <FileQuestion className="h-4 w-4" />,
};

// ============================================
// Template Card Component
// ============================================

interface TemplateCardProps {
  template: FindingTemplate;
  onSelect?: () => void;
  onEdit?: () => void;
  onDelete?: () => void;
  onDuplicate?: () => void;
  selectable?: boolean;
  selected?: boolean;
}

export function TemplateCard({
  template,
  onSelect,
  onEdit,
  onDelete,
  onDuplicate,
  selectable = false,
  selected = false,
}: TemplateCardProps) {
  const severityColors = FINDING_SEVERITY_COLORS[template.severity];

  return (
    <Card
      className={cn(
        "transition-all hover:shadow-md cursor-pointer",
        selectable && "hover:border-primary",
        selected && "border-primary ring-2 ring-primary/20"
      )}
      onClick={selectable ? onSelect : undefined}
    >
      <CardHeader className="pb-2">
        <div className="flex items-start justify-between gap-2">
          <div className="flex items-center gap-2 min-w-0">
            <div className="p-2 rounded-lg bg-muted">
              {categoryIcons[template.category]}
            </div>
            <div className="min-w-0">
              <CardTitle className="text-sm truncate">{template.name}</CardTitle>
              <CardDescription className="text-xs">
                {TEMPLATE_CATEGORY_LABELS[template.category]}
              </CardDescription>
            </div>
          </div>
          {selectable && selected && (
            <div className="p-1 bg-primary rounded-full text-primary-foreground">
              <Check className="h-3 w-3" />
            </div>
          )}
        </div>
      </CardHeader>
      <CardContent className="pt-0">
        <div className="flex flex-wrap gap-2 mb-3">
          <Badge className={cn(severityColors.bg, severityColors.text, "text-xs")}>
            {FINDING_SEVERITY_LABELS[template.severity]}
          </Badge>
          {template.owaspCategory && (
            <Badge variant="outline" className="text-xs">
              {template.owaspCategory}
            </Badge>
          )}
          {template.cweId && (
            <Badge variant="secondary" className="text-xs">
              {template.cweId}
            </Badge>
          )}
          {template.isBuiltIn && (
            <Badge variant="secondary" className="text-xs">
              <Star className="h-3 w-3 mr-1" />
              Built-in
            </Badge>
          )}
        </div>
        <p className="text-xs text-muted-foreground line-clamp-2 mb-3">
          {template.description}
        </p>
        {!selectable && (
          <div className="flex items-center justify-between">
            <span className="text-xs text-muted-foreground">
              Used {template.usageCount} times
            </span>
            <div className="flex gap-1">
              <Button
                size="icon"
                variant="ghost"
                className="h-7 w-7"
                onClick={(e) => {
                  e.stopPropagation();
                  onDuplicate?.();
                }}
              >
                <Copy className="h-3.5 w-3.5" />
              </Button>
              {!template.isBuiltIn && (
                <>
                  <Button
                    size="icon"
                    variant="ghost"
                    className="h-7 w-7"
                    onClick={(e) => {
                      e.stopPropagation();
                      onEdit?.();
                    }}
                  >
                    <Edit2 className="h-3.5 w-3.5" />
                  </Button>
                  <Button
                    size="icon"
                    variant="ghost"
                    className="h-7 w-7 text-destructive"
                    onClick={(e) => {
                      e.stopPropagation();
                      onDelete?.();
                    }}
                  >
                    <Trash2 className="h-3.5 w-3.5" />
                  </Button>
                </>
              )}
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}

// ============================================
// Template Detail Sheet
// ============================================

interface TemplateDetailSheetProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  template: FindingTemplate | null;
  onUse?: (template: FindingTemplate) => void;
  onEdit?: (template: FindingTemplate) => void;
  onDuplicate?: (template: FindingTemplate) => void;
}

export function TemplateDetailSheet({
  open,
  onOpenChange,
  template,
  onUse,
  onEdit,
  onDuplicate,
}: TemplateDetailSheetProps) {
  if (!template) return null;

  const severityColors = FINDING_SEVERITY_COLORS[template.severity];

  return (
    <Sheet open={open} onOpenChange={onOpenChange}>
      <SheetContent className="w-full sm:max-w-2xl p-0 flex flex-col">
        <div className="flex flex-col h-full overflow-hidden">
          {/* Header */}
          <div className="px-6 pt-6 pb-4 border-b">
            <div className="flex items-start gap-4">
              <div className="p-3 rounded-lg bg-muted">
                {categoryIcons[template.category]}
              </div>
              <div className="flex-1 min-w-0">
                <SheetTitle className="text-lg">{template.name}</SheetTitle>
                <SheetDescription>
                  {TEMPLATE_CATEGORY_LABELS[template.category]}
                </SheetDescription>
                <div className="flex flex-wrap gap-2 mt-2">
                  <Badge className={cn(severityColors.bg, severityColors.text)}>
                    {FINDING_SEVERITY_LABELS[template.severity]}
                  </Badge>
                  {template.owaspCategory && (
                    <Badge variant="outline">
                      {OWASP_CATEGORY_LABELS[template.owaspCategory]}
                    </Badge>
                  )}
                  {template.cweId && (
                    <Badge variant="secondary">{template.cweId}</Badge>
                  )}
                </div>
              </div>
            </div>
          </div>

          {/* Content */}
          <ScrollArea className="flex-1 overflow-auto">
            <div className="p-6 space-y-6">
              {/* Description */}
              <div>
                <Label className="text-sm font-medium mb-2 block">Description</Label>
                <p className="text-sm text-muted-foreground">{template.description}</p>
              </div>

              <Separator />

              {/* Steps to Reproduce */}
              <div>
                <Label className="text-sm font-medium mb-2 block">Steps to Reproduce</Label>
                <ol className="list-decimal list-inside space-y-2">
                  {template.stepsToReproduce.map((step, index) => (
                    <li key={index} className="text-sm text-muted-foreground">
                      {step}
                    </li>
                  ))}
                </ol>
              </div>

              <Separator />

              {/* Impact */}
              <div className="grid md:grid-cols-2 gap-4">
                <div>
                  <Label className="text-sm font-medium mb-2 block">Business Impact</Label>
                  <p className="text-sm text-muted-foreground">{template.businessImpact}</p>
                </div>
                <div>
                  <Label className="text-sm font-medium mb-2 block">Technical Impact</Label>
                  <p className="text-sm text-muted-foreground">{template.technicalImpact}</p>
                </div>
              </div>

              <Separator />

              {/* Remediation */}
              <div>
                <Label className="text-sm font-medium mb-2 block">Remediation</Label>
                <p className="text-sm text-muted-foreground">{template.remediation}</p>
              </div>

              {/* References */}
              {template.references.length > 0 && (
                <>
                  <Separator />
                  <div>
                    <Label className="text-sm font-medium mb-2 block">References</Label>
                    <ul className="space-y-1">
                      {template.references.map((ref, index) => (
                        <li key={index}>
                          <a
                            href={ref}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-sm text-primary hover:underline flex items-center gap-1"
                          >
                            {ref}
                            <ExternalLink className="h-3 w-3" />
                          </a>
                        </li>
                      ))}
                    </ul>
                  </div>
                </>
              )}

              {/* Tags */}
              {template.tags.length > 0 && (
                <>
                  <Separator />
                  <div>
                    <Label className="text-sm font-medium mb-2 block">Tags</Label>
                    <div className="flex flex-wrap gap-2">
                      {template.tags.map((tag) => (
                        <Badge key={tag} variant="outline">
                          {tag}
                        </Badge>
                      ))}
                    </div>
                  </div>
                </>
              )}
            </div>
          </ScrollArea>

          {/* Footer */}
          <div className="px-6 py-4 border-t flex justify-end gap-2">
            {!template.isBuiltIn && onEdit && (
              <Button variant="outline" onClick={() => onEdit(template)}>
                <Edit2 className="h-4 w-4 mr-2" />
                Edit
              </Button>
            )}
            {onDuplicate && (
              <Button variant="outline" onClick={() => onDuplicate(template)}>
                <Copy className="h-4 w-4 mr-2" />
                Duplicate
              </Button>
            )}
            {onUse && (
              <Button onClick={() => onUse(template)}>
                <FileText className="h-4 w-4 mr-2" />
                Use Template
              </Button>
            )}
          </div>
        </div>
      </SheetContent>
    </Sheet>
  );
}

// ============================================
// Template Editor Dialog
// ============================================

interface TemplateEditorDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  template?: FindingTemplate | null;
  onSave: (template: Partial<FindingTemplate>) => void;
  mode: "create" | "edit" | "duplicate";
}

export function TemplateEditorDialog({
  open,
  onOpenChange,
  template,
  onSave,
  mode,
}: TemplateEditorDialogProps) {
  const [formData, setFormData] = React.useState<Partial<FindingTemplate>>({
    name: "",
    category: "injection",
    severity: "medium",
    description: "",
    stepsToReproduce: [""],
    businessImpact: "",
    technicalImpact: "",
    remediation: "",
    references: [],
    tags: [],
    isBuiltIn: false,
  });

  React.useEffect(() => {
    if (template && (mode === "edit" || mode === "duplicate")) {
      setFormData({
        ...template,
        name: mode === "duplicate" ? `${template.name} (Copy)` : template.name,
        isBuiltIn: false,
      });
    } else if (mode === "create") {
      setFormData({
        name: "",
        category: "injection",
        severity: "medium",
        description: "",
        stepsToReproduce: [""],
        businessImpact: "",
        technicalImpact: "",
        remediation: "",
        references: [],
        tags: [],
        isBuiltIn: false,
      });
    }
  }, [template, mode, open]);

  const updateField = <K extends keyof FindingTemplate>(
    field: K,
    value: FindingTemplate[K]
  ) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
  };

  const addStep = () => {
    setFormData((prev) => ({
      ...prev,
      stepsToReproduce: [...(prev.stepsToReproduce || []), ""],
    }));
  };

  const updateStep = (index: number, value: string) => {
    const steps = [...(formData.stepsToReproduce || [])];
    steps[index] = value;
    setFormData((prev) => ({ ...prev, stepsToReproduce: steps }));
  };

  const removeStep = (index: number) => {
    const steps = (formData.stepsToReproduce || []).filter((_, i) => i !== index);
    setFormData((prev) => ({ ...prev, stepsToReproduce: steps }));
  };

  const handleSubmit = () => {
    onSave(formData);
    onOpenChange(false);
  };

  const title = {
    create: "Create Template",
    edit: "Edit Template",
    duplicate: "Duplicate Template",
  }[mode];

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl max-h-[90vh]">
        <DialogHeader>
          <DialogTitle>{title}</DialogTitle>
          <DialogDescription>
            {mode === "create"
              ? "Create a new finding template for reuse across campaigns."
              : mode === "edit"
              ? "Modify the template details."
              : "Create a copy of this template with modifications."}
          </DialogDescription>
        </DialogHeader>

        <ScrollArea className="max-h-[60vh] pr-4">
          <div className="space-y-6">
            {/* Basic Info */}
            <div className="grid grid-cols-2 gap-4">
              <div className="col-span-2">
                <Label htmlFor="name">Template Name</Label>
                <Input
                  id="name"
                  value={formData.name || ""}
                  onChange={(e) => updateField("name", e.target.value)}
                  placeholder="e.g., SQL Injection"
                  className="mt-1"
                />
              </div>
              <div>
                <Label>Category</Label>
                <Select
                  value={formData.category}
                  onValueChange={(v) => updateField("category", v as TemplateCategory)}
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {(Object.keys(TEMPLATE_CATEGORY_LABELS) as TemplateCategory[]).map(
                      (cat) => (
                        <SelectItem key={cat} value={cat}>
                          <div className="flex items-center gap-2">
                            {categoryIcons[cat]}
                            {TEMPLATE_CATEGORY_LABELS[cat]}
                          </div>
                        </SelectItem>
                      )
                    )}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Severity</Label>
                <Select
                  value={formData.severity}
                  onValueChange={(v) => updateField("severity", v as FindingSeverity)}
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {(Object.keys(FINDING_SEVERITY_LABELS) as FindingSeverity[]).map(
                      (sev) => (
                        <SelectItem key={sev} value={sev}>
                          {FINDING_SEVERITY_LABELS[sev]}
                        </SelectItem>
                      )
                    )}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>OWASP Category (Optional)</Label>
                <Select
                  value={formData.owaspCategory || "none"}
                  onValueChange={(v) =>
                    updateField("owaspCategory", v === "none" ? undefined : (v as OwaspCategory))
                  }
                >
                  <SelectTrigger className="mt-1">
                    <SelectValue placeholder="Select category" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="none">None</SelectItem>
                    {(Object.keys(OWASP_CATEGORY_LABELS) as OwaspCategory[]).map((cat) => (
                      <SelectItem key={cat} value={cat}>
                        {cat} - {OWASP_CATEGORY_LABELS[cat]}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label htmlFor="cweId">CWE ID (Optional)</Label>
                <Input
                  id="cweId"
                  value={formData.cweId || ""}
                  onChange={(e) => updateField("cweId", e.target.value)}
                  placeholder="e.g., CWE-89"
                  className="mt-1"
                />
              </div>
            </div>

            <Separator />

            {/* Description */}
            <div>
              <Label htmlFor="description">Description</Label>
              <Textarea
                id="description"
                value={formData.description || ""}
                onChange={(e) => updateField("description", e.target.value)}
                placeholder="Describe the vulnerability..."
                className="mt-1 min-h-[100px]"
              />
            </div>

            {/* Steps to Reproduce */}
            <div>
              <div className="flex items-center justify-between mb-2">
                <Label>Steps to Reproduce</Label>
                <Button type="button" size="sm" variant="outline" onClick={addStep}>
                  <Plus className="h-4 w-4 mr-1" />
                  Add Step
                </Button>
              </div>
              <div className="space-y-2">
                {(formData.stepsToReproduce || []).map((step, index) => (
                  <div key={index} className="flex gap-2">
                    <span className="text-sm text-muted-foreground pt-2 w-6">
                      {index + 1}.
                    </span>
                    <Input
                      value={step}
                      onChange={(e) => updateStep(index, e.target.value)}
                      placeholder={`Step ${index + 1}`}
                      className="flex-1"
                    />
                    {(formData.stepsToReproduce || []).length > 1 && (
                      <Button
                        type="button"
                        size="icon"
                        variant="ghost"
                        onClick={() => removeStep(index)}
                      >
                        <X className="h-4 w-4" />
                      </Button>
                    )}
                  </div>
                ))}
              </div>
            </div>

            <Separator />

            {/* Impact */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="businessImpact">Business Impact</Label>
                <Textarea
                  id="businessImpact"
                  value={formData.businessImpact || ""}
                  onChange={(e) => updateField("businessImpact", e.target.value)}
                  placeholder="Describe business impact..."
                  className="mt-1 min-h-[80px]"
                />
              </div>
              <div>
                <Label htmlFor="technicalImpact">Technical Impact</Label>
                <Textarea
                  id="technicalImpact"
                  value={formData.technicalImpact || ""}
                  onChange={(e) => updateField("technicalImpact", e.target.value)}
                  placeholder="Describe technical impact..."
                  className="mt-1 min-h-[80px]"
                />
              </div>
            </div>

            {/* Remediation */}
            <div>
              <Label htmlFor="remediation">Remediation</Label>
              <Textarea
                id="remediation"
                value={formData.remediation || ""}
                onChange={(e) => updateField("remediation", e.target.value)}
                placeholder="Describe how to fix this vulnerability..."
                className="mt-1 min-h-[80px]"
              />
            </div>

            {/* Tags */}
            <div>
              <Label htmlFor="tags">Tags (comma-separated)</Label>
              <Input
                id="tags"
                value={(formData.tags || []).join(", ")}
                onChange={(e) =>
                  updateField(
                    "tags",
                    e.target.value.split(",").map((t) => t.trim()).filter(Boolean)
                  )
                }
                placeholder="e.g., sqli, injection, database"
                className="mt-1"
              />
            </div>
          </div>
        </ScrollArea>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button onClick={handleSubmit} disabled={!formData.name || !formData.description}>
            {mode === "create" ? "Create Template" : "Save Changes"}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}

// ============================================
// Template Picker Dialog
// ============================================

interface TemplatePickerDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  templates: FindingTemplate[];
  onSelect: (template: FindingTemplate) => void;
}

export function TemplatePickerDialog({
  open,
  onOpenChange,
  templates,
  onSelect,
}: TemplatePickerDialogProps) {
  const [searchQuery, setSearchQuery] = React.useState("");
  const [filterCategory, setFilterCategory] = React.useState<string>("all");
  const [filterSeverity, setFilterSeverity] = React.useState<string>("all");
  const [selectedTemplate, setSelectedTemplate] = React.useState<FindingTemplate | null>(null);

  const filteredTemplates = React.useMemo(() => {
    return templates.filter((t) => {
      const matchesSearch =
        t.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        t.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
        t.tags.some((tag) => tag.toLowerCase().includes(searchQuery.toLowerCase()));
      const matchesCategory = filterCategory === "all" || t.category === filterCategory;
      const matchesSeverity = filterSeverity === "all" || t.severity === filterSeverity;
      return matchesSearch && matchesCategory && matchesSeverity;
    });
  }, [templates, searchQuery, filterCategory, filterSeverity]);

  const handleSelect = () => {
    if (selectedTemplate) {
      onSelect(selectedTemplate);
      onOpenChange(false);
      setSelectedTemplate(null);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-4xl max-h-[85vh]">
        <DialogHeader>
          <DialogTitle>Select Finding Template</DialogTitle>
          <DialogDescription>
            Choose a template to pre-fill the finding details.
          </DialogDescription>
        </DialogHeader>

        {/* Filters */}
        <div className="flex gap-2">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Search templates..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-9"
            />
          </div>
          <Select value={filterCategory} onValueChange={setFilterCategory}>
            <SelectTrigger className="w-[160px]">
              <SelectValue placeholder="Category" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Categories</SelectItem>
              {(Object.keys(TEMPLATE_CATEGORY_LABELS) as TemplateCategory[]).map((cat) => (
                <SelectItem key={cat} value={cat}>
                  {TEMPLATE_CATEGORY_LABELS[cat]}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
          <Select value={filterSeverity} onValueChange={setFilterSeverity}>
            <SelectTrigger className="w-[140px]">
              <SelectValue placeholder="Severity" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All Severities</SelectItem>
              {(Object.keys(FINDING_SEVERITY_LABELS) as FindingSeverity[]).map((sev) => (
                <SelectItem key={sev} value={sev}>
                  {FINDING_SEVERITY_LABELS[sev]}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        {/* Templates Grid */}
        <ScrollArea className="h-[400px]">
          {filteredTemplates.length === 0 ? (
            <div className="text-center py-12 text-muted-foreground">
              <BookTemplate className="h-12 w-12 mx-auto mb-4 opacity-50" />
              <p>No templates found matching your criteria.</p>
            </div>
          ) : (
            <div className="grid grid-cols-2 gap-4 pr-4">
              {filteredTemplates.map((template) => (
                <TemplateCard
                  key={template.id}
                  template={template}
                  selectable
                  selected={selectedTemplate?.id === template.id}
                  onSelect={() => setSelectedTemplate(template)}
                />
              ))}
            </div>
          )}
        </ScrollArea>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button onClick={handleSelect} disabled={!selectedTemplate}>
            Use Selected Template
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
