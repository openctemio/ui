'use client'

import { useState, useMemo, useCallback } from 'react'
import {
  ColumnDef,
  flexRender,
  getCoreRowModel,
  getFilteredRowModel,
  getPaginationRowModel,
  getSortedRowModel,
  SortingState,
  useReactTable,
} from '@tanstack/react-table'
import { Main } from '@/components/layout'
import { PageHeader } from '@/features/shared'
import {
  getFindings,
  getCampaigns,
  getCampaignById,
  FindingSeverityBadge,
  FindingStatusBadge,
  FindingDetailSheet,
  FINDING_SEVERITY_LABELS,
  FINDING_STATUS_LABELS,
  type PentestFinding,
  type FindingStatus,
  type Retest,
} from '@/features/pentest'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Badge } from '@/components/ui/badge'
import { Checkbox } from '@/components/ui/checkbox'
import { Textarea } from '@/components/ui/textarea'
import { Progress } from '@/components/ui/progress'
import { Card, CardContent } from '@/components/ui/card'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { toast } from 'sonner'
import {
  RefreshCw,
  Search as SearchIcon,
  MoreHorizontal,
  Eye,
  CheckCircle2,
  XCircle,
  ArrowUpDown,
  ChevronLeft,
  ChevronRight,
  ChevronsLeft,
  ChevronsRight,
  Clock,
  Play,
  FileText,
  Target,
} from 'lucide-react'

// Helper to get findings that need retest
function getRetestableFindings(findings: PentestFinding[]): PentestFinding[] {
  return findings.filter((f) => f.status === 'remediation' || f.status === 'retest')
}

// Helper to get all findings with retest history
function getFindingsWithRetests(findings: PentestFinding[]): PentestFinding[] {
  return findings.filter((f) => f.retests && f.retests.length > 0)
}

export default function PentestRetestsPage() {
  const [findings, setFindings] = useState<PentestFinding[]>(getFindings())
  const campaigns = getCampaigns()

  const [sorting, setSorting] = useState<SortingState>([])
  const [globalFilter, setGlobalFilter] = useState('')
  const [severityFilter, setSeverityFilter] = useState<string>('all')
  const [campaignFilter, setCampaignFilter] = useState<string>('all')
  const [activeTab, setActiveTab] = useState<'pending' | 'history'>('pending')

  const [retestDialogOpen, setRetestDialogOpen] = useState(false)
  const [detailSheetOpen, setDetailSheetOpen] = useState(false)
  const [selectedFinding, setSelectedFinding] = useState<PentestFinding | null>(null)
  const [retestNotes, setRetestNotes] = useState('')
  const [retestResult, setRetestResult] = useState<'passed' | 'failed'>('passed')

  // Get findings based on active tab
  const pendingRetests = useMemo(() => getRetestableFindings(findings), [findings])
  const retestHistory = useMemo(() => getFindingsWithRetests(findings), [findings])

  // Stats
  const stats = useMemo(() => {
    const pending = pendingRetests.length
    const totalRetests = retestHistory.reduce((acc, f) => acc + f.retests.length, 0)
    const passed = retestHistory.reduce(
      (acc, f) => acc + f.retests.filter((r) => r.result === 'passed').length,
      0
    )
    const failed = retestHistory.reduce(
      (acc, f) => acc + f.retests.filter((r) => r.result === 'failed').length,
      0
    )
    const successRate = totalRetests > 0 ? Math.round((passed / totalRetests) * 100) : 0

    return { pending, totalRetests, passed, failed, successRate }
  }, [pendingRetests, retestHistory])

  // Filter data
  const filteredPending = useMemo(() => {
    return pendingRetests.filter((finding) => {
      const matchesSearch =
        finding.title.toLowerCase().includes(globalFilter.toLowerCase()) ||
        finding.description.toLowerCase().includes(globalFilter.toLowerCase())
      const matchesSeverity = severityFilter === 'all' || finding.severity === severityFilter
      const matchesCampaign = campaignFilter === 'all' || finding.campaignId === campaignFilter
      return matchesSearch && matchesSeverity && matchesCampaign
    })
  }, [pendingRetests, globalFilter, severityFilter, campaignFilter])

  const filteredHistory = useMemo(() => {
    return retestHistory.filter((finding) => {
      const matchesSearch =
        finding.title.toLowerCase().includes(globalFilter.toLowerCase()) ||
        finding.description.toLowerCase().includes(globalFilter.toLowerCase())
      const matchesSeverity = severityFilter === 'all' || finding.severity === severityFilter
      const matchesCampaign = campaignFilter === 'all' || finding.campaignId === campaignFilter
      return matchesSearch && matchesSeverity && matchesCampaign
    })
  }, [retestHistory, globalFilter, severityFilter, campaignFilter])

  const getCampaignName = useCallback(
    (campaignId: string) => {
      const campaign = campaigns.find((c) => c.id === campaignId)
      return campaign?.name || 'Unknown Campaign'
    },
    [campaigns]
  )

  // Define handlers before columns to avoid hoisting issues
  const handleView = useCallback((finding: PentestFinding) => {
    setSelectedFinding(finding)
    setDetailSheetOpen(true)
  }, [])

  const handleStartRetest = useCallback((finding: PentestFinding) => {
    setSelectedFinding(finding)
    setRetestNotes('')
    setRetestResult('passed')
    setRetestDialogOpen(true)
  }, [])

  // Pending retests columns
  const pendingColumns: ColumnDef<PentestFinding>[] = useMemo(
    () => [
      {
        id: 'select',
        header: ({ table }) => (
          <Checkbox
            checked={table.getIsAllPageRowsSelected()}
            onCheckedChange={(value) => table.toggleAllPageRowsSelected(!!value)}
            aria-label="Select all"
          />
        ),
        cell: ({ row }) => (
          <Checkbox
            checked={row.getIsSelected()}
            onCheckedChange={(value) => row.toggleSelected(!!value)}
            aria-label="Select row"
          />
        ),
        enableSorting: false,
      },
      {
        accessorKey: 'title',
        header: ({ column }) => (
          <Button
            variant="ghost"
            onClick={() => column.toggleSorting(column.getIsSorted() === 'asc')}
            className="-ml-4"
          >
            Finding
            <ArrowUpDown className="ml-2 h-4 w-4" />
          </Button>
        ),
        cell: ({ row }) => (
          <div className="flex flex-col gap-1 max-w-[350px]">
            <span className="font-medium truncate">{row.original.title}</span>
            <span className="text-xs text-muted-foreground truncate">
              {getCampaignName(row.original.campaignId)}
            </span>
          </div>
        ),
      },
      {
        accessorKey: 'severity',
        header: 'Severity',
        cell: ({ row }) => <FindingSeverityBadge severity={row.original.severity} />,
      },
      {
        accessorKey: 'status',
        header: 'Status',
        cell: ({ row }) => <FindingStatusBadge status={row.original.status} />,
      },
      {
        accessorKey: 'affectedAssets',
        header: 'Assets',
        cell: ({ row }) => (
          <Badge variant="secondary" className="text-xs">
            {row.original.affectedAssets.length} asset
            {row.original.affectedAssets.length !== 1 ? 's' : ''}
          </Badge>
        ),
      },
      {
        accessorKey: 'retests',
        header: 'Previous Retests',
        cell: ({ row }) => {
          const retests = row.original.retests
          if (retests.length === 0) {
            return <span className="text-muted-foreground text-sm">None</span>
          }
          const passed = retests.filter((r) => r.result === 'passed').length
          const failed = retests.filter((r) => r.result === 'failed').length
          return (
            <div className="flex flex-wrap items-center gap-2">
              {passed > 0 && (
                <Badge variant="outline" className="text-green-600 border-green-300 text-xs">
                  {passed} passed
                </Badge>
              )}
              {failed > 0 && (
                <Badge variant="outline" className="text-red-600 border-red-300 text-xs">
                  {failed} failed
                </Badge>
              )}
            </div>
          )
        },
      },
      {
        accessorKey: 'updatedAt',
        header: 'Last Updated',
        cell: ({ row }) => (
          <span className="text-sm text-muted-foreground">
            {new Date(row.original.updatedAt).toLocaleDateString()}
          </span>
        ),
      },
      {
        id: 'actions',
        cell: ({ row }) => (
          <div className="flex flex-wrap items-center gap-2">
            <Button
              size="sm"
              onClick={(e) => {
                e.stopPropagation()
                handleStartRetest(row.original)
              }}
            >
              <Play className="h-4 w-4 mr-1" />
              Retest
            </Button>
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" size="icon" className="h-8 w-8">
                  <MoreHorizontal className="h-4 w-4" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => handleView(row.original)}>
                  <Eye className="mr-2 h-4 w-4" />
                  View Details
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>
        ),
      },
    ],
    [getCampaignName, handleStartRetest, handleView]
  )

  // History columns
  const historyColumns: ColumnDef<PentestFinding>[] = useMemo(
    () => [
      {
        accessorKey: 'title',
        header: ({ column }) => (
          <Button
            variant="ghost"
            onClick={() => column.toggleSorting(column.getIsSorted() === 'asc')}
            className="-ml-4"
          >
            Finding
            <ArrowUpDown className="ml-2 h-4 w-4" />
          </Button>
        ),
        cell: ({ row }) => (
          <div className="flex flex-col gap-1 max-w-[300px]">
            <span className="font-medium truncate">{row.original.title}</span>
            <span className="text-xs text-muted-foreground truncate">
              {getCampaignName(row.original.campaignId)}
            </span>
          </div>
        ),
      },
      {
        accessorKey: 'severity',
        header: 'Severity',
        cell: ({ row }) => <FindingSeverityBadge severity={row.original.severity} />,
      },
      {
        accessorKey: 'status',
        header: 'Current Status',
        cell: ({ row }) => <FindingStatusBadge status={row.original.status} />,
      },
      {
        accessorKey: 'retests',
        header: 'Retest Results',
        cell: ({ row }) => {
          const retests = row.original.retests
          const passed = retests.filter((r) => r.result === 'passed').length
          const _failed = retests.filter((r) => r.result === 'failed').length
          const total = retests.length
          const successRate = total > 0 ? Math.round((passed / total) * 100) : 0

          return (
            <div className="flex items-center gap-3 min-w-[150px]">
              <div className="flex-1">
                <div className="flex items-center justify-between mb-1">
                  <span className="text-xs text-muted-foreground">
                    {passed}/{total} passed
                  </span>
                  <span className="text-xs font-medium">{successRate}%</span>
                </div>
                <Progress value={successRate} className="h-1.5" />
              </div>
            </div>
          )
        },
      },
      {
        accessorKey: 'lastRetest',
        header: 'Last Retest',
        cell: ({ row }) => {
          const lastRetest = row.original.retests[row.original.retests.length - 1]
          if (!lastRetest) return null

          return (
            <div className="flex flex-wrap items-center gap-2">
              {lastRetest.result === 'passed' ? (
                <CheckCircle2 className="h-4 w-4 text-green-500" />
              ) : (
                <XCircle className="h-4 w-4 text-red-500" />
              )}
              <span className="text-sm text-muted-foreground">
                {new Date(lastRetest.testedAt).toLocaleDateString()}
              </span>
            </div>
          )
        },
      },
      {
        id: 'actions',
        cell: ({ row }) => (
          <Button
            variant="ghost"
            size="icon"
            className="h-8 w-8"
            onClick={() => handleView(row.original)}
          >
            <Eye className="h-4 w-4" />
          </Button>
        ),
      },
    ],
    [getCampaignName, handleView]
  )

  const pendingTable = useReactTable({
    data: filteredPending,
    columns: pendingColumns,
    state: { sorting, globalFilter },
    onSortingChange: setSorting,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    initialState: { pagination: { pageSize: 10 } },
  })

  const historyTable = useReactTable({
    data: filteredHistory,
    columns: historyColumns,
    state: { sorting, globalFilter },
    onSortingChange: setSorting,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    initialState: { pagination: { pageSize: 10 } },
  })

  const handleSubmitRetest = () => {
    if (!selectedFinding || !retestNotes.trim()) {
      toast.error('Please provide retest notes')
      return
    }

    const newRetest: Retest = {
      id: `retest-${Date.now()}`,
      testedBy: 'current-user',
      testedAt: new Date().toISOString(),
      result: retestResult,
      notes: retestNotes,
      evidence: [],
    }

    const newStatus: FindingStatus = retestResult === 'passed' ? 'verified' : 'remediation'

    setFindings((prev) =>
      prev.map((f) =>
        f.id === selectedFinding.id
          ? {
              ...f,
              status: newStatus,
              retests: [...f.retests, newRetest],
              updatedAt: new Date().toISOString(),
            }
          : f
      )
    )

    setRetestDialogOpen(false)
    setSelectedFinding(null)
    toast.success(
      retestResult === 'passed'
        ? 'Retest passed - finding marked as verified'
        : 'Retest failed - finding sent back to remediation'
    )
  }

  const handleStatusChange = (finding: PentestFinding, newStatus: FindingStatus) => {
    setFindings((prev) =>
      prev.map((f) =>
        f.id === finding.id ? { ...f, status: newStatus, updatedAt: new Date().toISOString() } : f
      )
    )
    toast.success(`Status updated to ${FINDING_STATUS_LABELS[newStatus]}`)
  }

  const _currentTable = activeTab === 'pending' ? pendingTable : historyTable
  const _currentData = activeTab === 'pending' ? filteredPending : filteredHistory

  return (
    <>
      <Main>
        <PageHeader
          title="Retest Management"
          description="Verify remediation effectiveness and track retest results"
        />

        {/* Stats Cards */}
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
          <Card>
            <CardContent className="pt-4">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-lg bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                  <Clock className="h-5 w-5 text-orange-600" />
                </div>
                <div>
                  <p className="text-2xl font-bold">{stats.pending}</p>
                  <p className="text-xs text-muted-foreground">Pending</p>
                </div>
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardContent className="pt-4">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center">
                  <RefreshCw className="h-5 w-5 text-blue-600" />
                </div>
                <div>
                  <p className="text-2xl font-bold">{stats.totalRetests}</p>
                  <p className="text-xs text-muted-foreground">Total Retests</p>
                </div>
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardContent className="pt-4">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-lg bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                  <CheckCircle2 className="h-5 w-5 text-green-600" />
                </div>
                <div>
                  <p className="text-2xl font-bold">{stats.passed}</p>
                  <p className="text-xs text-muted-foreground">Passed</p>
                </div>
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardContent className="pt-4">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-lg bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                  <XCircle className="h-5 w-5 text-red-600" />
                </div>
                <div>
                  <p className="text-2xl font-bold">{stats.failed}</p>
                  <p className="text-xs text-muted-foreground">Failed</p>
                </div>
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardContent className="pt-4">
              <div className="flex items-center gap-3">
                <div className="h-10 w-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center">
                  <Target className="h-5 w-5 text-purple-600" />
                </div>
                <div>
                  <p className="text-2xl font-bold">{stats.successRate}%</p>
                  <p className="text-xs text-muted-foreground">Success Rate</p>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Filters */}
        <Card className="mb-6">
          <CardContent className="pt-6">
            <div className="flex flex-col sm:flex-row gap-4">
              <div className="relative flex-1">
                <SearchIcon className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder="Search findings..."
                  value={globalFilter}
                  onChange={(e) => setGlobalFilter(e.target.value)}
                  className="pl-9"
                />
              </div>
              <Select value={severityFilter} onValueChange={setSeverityFilter}>
                <SelectTrigger className="w-[140px]">
                  <SelectValue placeholder="Severity" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Severity</SelectItem>
                  {Object.entries(FINDING_SEVERITY_LABELS).map(([value, label]) => (
                    <SelectItem key={value} value={value}>
                      {label}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <Select value={campaignFilter} onValueChange={setCampaignFilter}>
                <SelectTrigger className="w-[200px]">
                  <SelectValue placeholder="Campaign" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All Campaigns</SelectItem>
                  {campaigns.map((campaign) => (
                    <SelectItem key={campaign.id} value={campaign.id}>
                      {campaign.name.substring(0, 30)}...
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </CardContent>
        </Card>

        {/* Tabs */}
        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as 'pending' | 'history')}>
          <TabsList className="mb-4">
            <TabsTrigger value="pending" className="gap-2">
              <Clock className="h-4 w-4" />
              Pending Retests
              {stats.pending > 0 && (
                <Badge variant="secondary" className="ml-1">
                  {stats.pending}
                </Badge>
              )}
            </TabsTrigger>
            <TabsTrigger value="history" className="gap-2">
              <FileText className="h-4 w-4" />
              Retest History
            </TabsTrigger>
          </TabsList>

          <TabsContent value="pending">
            <Card>
              <CardContent className="pt-6">
                {filteredPending.length === 0 ? (
                  <div className="text-center py-12 text-muted-foreground">
                    <CheckCircle2 className="h-12 w-12 mx-auto mb-4 opacity-50" />
                    <h3 className="font-medium mb-1">No Pending Retests</h3>
                    <p className="text-sm">
                      All findings have been verified or are awaiting remediation
                    </p>
                  </div>
                ) : (
                  <>
                    <div className="rounded-md border">
                      <Table>
                        <TableHeader>
                          {pendingTable.getHeaderGroups().map((headerGroup) => (
                            <TableRow key={headerGroup.id}>
                              {headerGroup.headers.map((header) => (
                                <TableHead key={header.id}>
                                  {header.isPlaceholder
                                    ? null
                                    : flexRender(
                                        header.column.columnDef.header,
                                        header.getContext()
                                      )}
                                </TableHead>
                              ))}
                            </TableRow>
                          ))}
                        </TableHeader>
                        <TableBody>
                          {pendingTable.getRowModel().rows.map((row) => (
                            <TableRow
                              key={row.id}
                              data-state={row.getIsSelected() && 'selected'}
                              className="cursor-pointer"
                              onClick={() => handleView(row.original)}
                            >
                              {row.getVisibleCells().map((cell) => (
                                <TableCell
                                  key={cell.id}
                                  onClick={(e) => {
                                    if (
                                      cell.column.id === 'select' ||
                                      cell.column.id === 'actions'
                                    ) {
                                      e.stopPropagation()
                                    }
                                  }}
                                >
                                  {flexRender(cell.column.columnDef.cell, cell.getContext())}
                                </TableCell>
                              ))}
                            </TableRow>
                          ))}
                        </TableBody>
                      </Table>
                    </div>

                    <div className="flex items-center justify-between mt-4">
                      <p className="text-sm text-muted-foreground">
                        Showing{' '}
                        {pendingTable.getState().pagination.pageIndex *
                          pendingTable.getState().pagination.pageSize +
                          1}{' '}
                        to{' '}
                        {Math.min(
                          (pendingTable.getState().pagination.pageIndex + 1) *
                            pendingTable.getState().pagination.pageSize,
                          filteredPending.length
                        )}{' '}
                        of {filteredPending.length} findings
                      </p>
                      <div className="flex flex-wrap items-center gap-2">
                        <Button
                          variant="outline"
                          size="icon"
                          onClick={() => pendingTable.setPageIndex(0)}
                          disabled={!pendingTable.getCanPreviousPage()}
                        >
                          <ChevronsLeft className="h-4 w-4" />
                        </Button>
                        <Button
                          variant="outline"
                          size="icon"
                          onClick={() => pendingTable.previousPage()}
                          disabled={!pendingTable.getCanPreviousPage()}
                        >
                          <ChevronLeft className="h-4 w-4" />
                        </Button>
                        <span className="text-sm">
                          Page {pendingTable.getState().pagination.pageIndex + 1} of{' '}
                          {pendingTable.getPageCount() || 1}
                        </span>
                        <Button
                          variant="outline"
                          size="icon"
                          onClick={() => pendingTable.nextPage()}
                          disabled={!pendingTable.getCanNextPage()}
                        >
                          <ChevronRight className="h-4 w-4" />
                        </Button>
                        <Button
                          variant="outline"
                          size="icon"
                          onClick={() => pendingTable.setPageIndex(pendingTable.getPageCount() - 1)}
                          disabled={!pendingTable.getCanNextPage()}
                        >
                          <ChevronsRight className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  </>
                )}
              </CardContent>
            </Card>
          </TabsContent>

          <TabsContent value="history">
            <Card>
              <CardContent className="pt-6">
                {filteredHistory.length === 0 ? (
                  <div className="text-center py-12 text-muted-foreground">
                    <RefreshCw className="h-12 w-12 mx-auto mb-4 opacity-50" />
                    <h3 className="font-medium mb-1">No Retest History</h3>
                    <p className="text-sm">Retest results will appear here once completed</p>
                  </div>
                ) : (
                  <>
                    <div className="rounded-md border">
                      <Table>
                        <TableHeader>
                          {historyTable.getHeaderGroups().map((headerGroup) => (
                            <TableRow key={headerGroup.id}>
                              {headerGroup.headers.map((header) => (
                                <TableHead key={header.id}>
                                  {header.isPlaceholder
                                    ? null
                                    : flexRender(
                                        header.column.columnDef.header,
                                        header.getContext()
                                      )}
                                </TableHead>
                              ))}
                            </TableRow>
                          ))}
                        </TableHeader>
                        <TableBody>
                          {historyTable.getRowModel().rows.map((row) => (
                            <TableRow
                              key={row.id}
                              className="cursor-pointer"
                              onClick={() => handleView(row.original)}
                            >
                              {row.getVisibleCells().map((cell) => (
                                <TableCell key={cell.id}>
                                  {flexRender(cell.column.columnDef.cell, cell.getContext())}
                                </TableCell>
                              ))}
                            </TableRow>
                          ))}
                        </TableBody>
                      </Table>
                    </div>

                    <div className="flex items-center justify-between mt-4">
                      <p className="text-sm text-muted-foreground">
                        Showing{' '}
                        {historyTable.getState().pagination.pageIndex *
                          historyTable.getState().pagination.pageSize +
                          1}{' '}
                        to{' '}
                        {Math.min(
                          (historyTable.getState().pagination.pageIndex + 1) *
                            historyTable.getState().pagination.pageSize,
                          filteredHistory.length
                        )}{' '}
                        of {filteredHistory.length} findings
                      </p>
                      <div className="flex flex-wrap items-center gap-2">
                        <Button
                          variant="outline"
                          size="icon"
                          onClick={() => historyTable.setPageIndex(0)}
                          disabled={!historyTable.getCanPreviousPage()}
                        >
                          <ChevronsLeft className="h-4 w-4" />
                        </Button>
                        <Button
                          variant="outline"
                          size="icon"
                          onClick={() => historyTable.previousPage()}
                          disabled={!historyTable.getCanPreviousPage()}
                        >
                          <ChevronLeft className="h-4 w-4" />
                        </Button>
                        <span className="text-sm">
                          Page {historyTable.getState().pagination.pageIndex + 1} of{' '}
                          {historyTable.getPageCount() || 1}
                        </span>
                        <Button
                          variant="outline"
                          size="icon"
                          onClick={() => historyTable.nextPage()}
                          disabled={!historyTable.getCanNextPage()}
                        >
                          <ChevronRight className="h-4 w-4" />
                        </Button>
                        <Button
                          variant="outline"
                          size="icon"
                          onClick={() => historyTable.setPageIndex(historyTable.getPageCount() - 1)}
                          disabled={!historyTable.getCanNextPage()}
                        >
                          <ChevronsRight className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  </>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      </Main>

      {/* Finding Detail Sheet */}
      <FindingDetailSheet
        open={detailSheetOpen}
        onOpenChange={setDetailSheetOpen}
        finding={selectedFinding}
        campaign={selectedFinding ? getCampaignById(selectedFinding.campaignId) : null}
        onStatusChange={handleStatusChange}
      />

      {/* Retest Dialog */}
      <Dialog open={retestDialogOpen} onOpenChange={setRetestDialogOpen}>
        <DialogContent className="max-w-lg">
          <DialogHeader>
            <DialogTitle>Submit Retest Result</DialogTitle>
            <DialogDescription>Record the result of retesting this vulnerability</DialogDescription>
          </DialogHeader>

          {selectedFinding && (
            <div className="space-y-4">
              {/* Finding Info */}
              <div className="p-4 rounded-lg bg-muted/50">
                <div className="flex items-center gap-2 mb-2">
                  <FindingSeverityBadge severity={selectedFinding.severity} />
                  <FindingStatusBadge status={selectedFinding.status} />
                </div>
                <h4 className="font-medium">{selectedFinding.title}</h4>
                <p className="text-sm text-muted-foreground mt-1">
                  {getCampaignName(selectedFinding.campaignId)}
                </p>
              </div>

              {/* Result Selection */}
              <div className="space-y-2">
                <Label>Retest Result</Label>
                <div className="grid grid-cols-2 gap-4">
                  <Button
                    type="button"
                    variant={retestResult === 'passed' ? 'default' : 'outline'}
                    className={retestResult === 'passed' ? 'bg-green-600 hover:bg-green-700' : ''}
                    onClick={() => setRetestResult('passed')}
                  >
                    <CheckCircle2 className="h-4 w-4 mr-2" />
                    Passed
                  </Button>
                  <Button
                    type="button"
                    variant={retestResult === 'failed' ? 'default' : 'outline'}
                    className={retestResult === 'failed' ? 'bg-red-600 hover:bg-red-700' : ''}
                    onClick={() => setRetestResult('failed')}
                  >
                    <XCircle className="h-4 w-4 mr-2" />
                    Failed
                  </Button>
                </div>
              </div>

              {/* Notes */}
              <div className="space-y-2">
                <Label htmlFor="retestNotes">Retest Notes *</Label>
                <Textarea
                  id="retestNotes"
                  placeholder={
                    retestResult === 'passed'
                      ? 'Describe how the vulnerability was verified as fixed...'
                      : 'Describe why the remediation was insufficient...'
                  }
                  value={retestNotes}
                  onChange={(e) => setRetestNotes(e.target.value)}
                  rows={5}
                />
              </div>

              {/* Result Preview */}
              <div
                className={`p-3 rounded-lg ${retestResult === 'passed' ? 'bg-green-50 dark:bg-green-900/20 border border-green-200' : 'bg-red-50 dark:bg-red-900/20 border border-red-200'}`}
              >
                <p
                  className={`text-sm ${retestResult === 'passed' ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'}`}
                >
                  {retestResult === 'passed'
                    ? 'Finding will be marked as Verified'
                    : 'Finding will be sent back to Remediation'}
                </p>
              </div>
            </div>
          )}

          <DialogFooter>
            <Button variant="outline" onClick={() => setRetestDialogOpen(false)}>
              Cancel
            </Button>
            <Button onClick={handleSubmitRetest}>Submit Retest</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  )
}
