'use client'

import * as React from 'react'
import { useRouter, useSearchParams } from 'next/navigation'
import { Main } from '@/components/layout'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Badge } from '@/components/ui/badge'
import { Separator } from '@/components/ui/separator'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from '@/components/ui/breadcrumb'
import { MarkdownEditor } from '@/components/ui/markdown-editor'
import { cn } from '@/lib/utils'
import { toast } from 'sonner'
import { getErrorMessage } from '@/lib/api/error-handler'
import {
  ArrowLeft,
  Save,
  Plus,
  X,
  Syringe,
  Key,
  Shield,
  Lock,
  Settings,
  Eye,
  Clock,
  FormInput,
  GitBranch,
  FileQuestion,
  ExternalLink,
  AlertCircle,
  GripVertical,
  Trash2,
  Loader2,
  Command,
} from 'lucide-react'
import type {
  FindingTemplate,
  TemplateCategory,
  FindingSeverity,
  OwaspCategory,
} from '@/features/pentest/types'
import {
  TEMPLATE_CATEGORY_LABELS,
  FINDING_SEVERITY_LABELS,
  OWASP_CATEGORY_LABELS,
  BUILTIN_TEMPLATES,
} from '@/features/pentest/types'

// Category icons
const categoryIcons: Record<TemplateCategory, React.ReactNode> = {
  injection: <Syringe className="h-4 w-4" />,
  authentication: <Key className="h-4 w-4" />,
  authorization: <Shield className="h-4 w-4" />,
  cryptographic: <Lock className="h-4 w-4" />,
  configuration: <Settings className="h-4 w-4" />,
  disclosure: <Eye className="h-4 w-4" />,
  session: <Clock className="h-4 w-4" />,
  input_validation: <FormInput className="h-4 w-4" />,
  logic: <GitBranch className="h-4 w-4" />,
  other: <FileQuestion className="h-4 w-4" />,
}

// Severity colors
const severityColors: Record<FindingSeverity, string> = {
  critical: 'bg-red-500',
  high: 'bg-orange-500',
  medium: 'bg-yellow-500',
  low: 'bg-blue-500',
  info: 'bg-gray-400',
}

interface FormData {
  name: string
  category: TemplateCategory
  severity: FindingSeverity
  owaspCategory: OwaspCategory | ''
  cweId: string
  description: string
  stepsToReproduce: string[]
  businessImpact: string
  technicalImpact: string
  remediation: string
  references: string[]
  tags: string[]
}

const initialFormData: FormData = {
  name: '',
  category: 'other',
  severity: 'medium',
  owaspCategory: '',
  cweId: '',
  description: '',
  stepsToReproduce: [''],
  businessImpact: '',
  technicalImpact: '',
  remediation: '',
  references: [],
  tags: [],
}

const AUTOSAVE_KEY = 'pentest-template-draft'

export default function NewTemplatePage() {
  const router = useRouter()
  const searchParams = useSearchParams()
  const duplicateId = searchParams.get('duplicate')

  const [formData, setFormData] = React.useState<FormData>(initialFormData)
  const [newTag, setNewTag] = React.useState('')
  const [newReference, setNewReference] = React.useState('')
  const [isSaving, setIsSaving] = React.useState(false)
  const [errors, setErrors] = React.useState<Record<string, string>>({})
  const [lastSaved, setLastSaved] = React.useState<Date | null>(null)
  const [isDirty, setIsDirty] = React.useState(false)

  // Load draft or duplicate template on mount
  React.useEffect(() => {
    if (duplicateId) {
      // Load from builtin templates
      const index = parseInt(duplicateId.replace('builtin-', '')) - 1
      const template = BUILTIN_TEMPLATES[index]
      if (template) {
        setFormData({
          name: `${template.name} (Copy)`,
          category: template.category || 'other',
          severity: template.severity || 'medium',
          owaspCategory: template.owaspCategory || '',
          cweId: template.cweId || '',
          description: template.description || '',
          stepsToReproduce: template.stepsToReproduce?.length ? template.stepsToReproduce : [''],
          businessImpact: template.businessImpact || '',
          technicalImpact: template.technicalImpact || '',
          remediation: template.remediation || '',
          references: template.references || [],
          tags: template.tags || [],
        })
      }
    } else {
      // Load draft from localStorage
      const draft = localStorage.getItem(AUTOSAVE_KEY)
      if (draft) {
        try {
          const parsed = JSON.parse(draft)
          setFormData(parsed)
          setLastSaved(new Date())
          toast.info('Draft restored from previous session')
        } catch {
          // Ignore parse errors
        }
      }
    }
  }, [duplicateId])

  // Autosave to localStorage
  React.useEffect(() => {
    if (!isDirty) return

    const timeout = setTimeout(() => {
      localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(formData))
      setLastSaved(new Date())
    }, 2000)

    return () => clearTimeout(timeout)
  }, [formData, isDirty])

  const updateField = <K extends keyof FormData>(field: K, value: FormData[K]) => {
    setFormData((prev) => ({ ...prev, [field]: value }))
    setIsDirty(true)
    if (errors[field]) {
      setErrors((prev) => {
        const newErrors = { ...prev }
        delete newErrors[field]
        return newErrors
      })
    }
  }

  // Steps management
  const addStep = () => {
    updateField('stepsToReproduce', [...formData.stepsToReproduce, ''])
  }

  const updateStep = (index: number, value: string) => {
    const newSteps = [...formData.stepsToReproduce]
    newSteps[index] = value
    updateField('stepsToReproduce', newSteps)
  }

  const removeStep = (index: number) => {
    if (formData.stepsToReproduce.length === 1) return
    const newSteps = formData.stepsToReproduce.filter((_, i) => i !== index)
    updateField('stepsToReproduce', newSteps)
  }

  // Tags management
  const addTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      updateField('tags', [...formData.tags, newTag.trim()])
      setNewTag('')
    }
  }

  const removeTag = (tag: string) => {
    updateField(
      'tags',
      formData.tags.filter((t) => t !== tag)
    )
  }

  // References management
  const addReference = () => {
    if (newReference.trim() && !formData.references.includes(newReference.trim())) {
      updateField('references', [...formData.references, newReference.trim()])
      setNewReference('')
    }
  }

  const removeReference = (ref: string) => {
    updateField(
      'references',
      formData.references.filter((r) => r !== ref)
    )
  }

  const validate = React.useCallback((): boolean => {
    const newErrors: Record<string, string> = {}

    if (!formData.name.trim()) {
      newErrors.name = 'Template name is required'
    }
    if (!formData.description.trim()) {
      newErrors.description = 'Description is required'
    }
    if (!formData.remediation.trim()) {
      newErrors.remediation = 'Remediation guidance is required'
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }, [formData.name, formData.description, formData.remediation])

  const handleSave = React.useCallback(async () => {
    if (!validate()) {
      toast.error('Please fill in all required fields')
      return
    }

    setIsSaving(true)
    try {
      // TODO: Replace with actual API call
      await new Promise((resolve) => setTimeout(resolve, 1000))

      const template: Partial<FindingTemplate> = {
        ...formData,
        owaspCategory: formData.owaspCategory || undefined,
        stepsToReproduce: formData.stepsToReproduce.filter((s) => s.trim()),
      }

      console.log('Saving template:', template)

      // Clear draft
      localStorage.removeItem(AUTOSAVE_KEY)

      toast.success('Template created successfully')
      router.push('/pentest/templates')
    } catch (err) {
      toast.error(getErrorMessage(err, 'Failed to create template'))
    } finally {
      setIsSaving(false)
    }
  }, [formData, validate, router])

  // Keyboard shortcuts
  React.useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 's') {
        e.preventDefault()
        handleSave()
      }
    }

    document.addEventListener('keydown', handleKeyDown)
    return () => document.removeEventListener('keydown', handleKeyDown)
  }, [handleSave])

  const handleCancel = () => {
    if (isDirty) {
      const confirmed = window.confirm('You have unsaved changes. Are you sure you want to leave?')
      if (!confirmed) return
    }
    localStorage.removeItem(AUTOSAVE_KEY)
    router.push('/pentest/templates')
  }

  return (
    <>
      <Main>
        <div className="flex flex-col gap-6 max-w-5xl mx-auto">
          {/* Breadcrumb */}
          <Breadcrumb>
            <BreadcrumbList>
              <BreadcrumbItem>
                <BreadcrumbLink href="/pentest/templates">Templates</BreadcrumbLink>
              </BreadcrumbItem>
              <BreadcrumbSeparator />
              <BreadcrumbItem>
                <BreadcrumbPage>
                  {duplicateId ? 'Duplicate Template' : 'New Template'}
                </BreadcrumbPage>
              </BreadcrumbItem>
            </BreadcrumbList>
          </Breadcrumb>

          {/* Header */}
          <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
            <div className="flex items-center gap-4">
              <Button variant="ghost" size="icon" onClick={handleCancel}>
                <ArrowLeft className="h-4 w-4" />
              </Button>
              <div>
                <h1 className="text-xl sm:text-2xl font-bold">
                  {duplicateId ? 'Duplicate Template' : 'Create Template'}
                </h1>
                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                  {lastSaved && (
                    <span className="hidden sm:inline">
                      Draft saved {lastSaved.toLocaleTimeString()}
                    </span>
                  )}
                  <span className="hidden sm:inline text-muted-foreground/50">|</span>
                  <span className="flex items-center gap-1">
                    <Command className="h-3 w-3" />S to save
                  </span>
                </div>
              </div>
            </div>
            <div className="flex gap-2 ml-12 sm:ml-0">
              <Button
                variant="outline"
                onClick={handleCancel}
                size="sm"
                className="sm:size-default"
              >
                Cancel
              </Button>
              <Button
                onClick={handleSave}
                disabled={isSaving}
                size="sm"
                className="sm:size-default"
              >
                {isSaving ? (
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                ) : (
                  <Save className="h-4 w-4 mr-2" />
                )}
                {isSaving ? 'Saving...' : 'Save'}
              </Button>
            </div>
          </div>

          {/* Form */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Main Content */}
            <div className="lg:col-span-2 space-y-6">
              {/* Basic Info */}
              <Card>
                <CardHeader className="pb-4">
                  <CardTitle className="text-base">Basic Information</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="space-y-2">
                    <Label htmlFor="name">
                      Template Name <span className="text-destructive">*</span>
                    </Label>
                    <Input
                      id="name"
                      placeholder="e.g., SQL Injection in Login Form"
                      value={formData.name}
                      onChange={(e) => updateField('name', e.target.value)}
                      className={errors.name ? 'border-destructive' : ''}
                    />
                    {errors.name && (
                      <p className="text-sm text-destructive flex items-center gap-1">
                        <AlertCircle className="h-3 w-3" />
                        {errors.name}
                      </p>
                    )}
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <Label>Category</Label>
                      <Select
                        value={formData.category}
                        onValueChange={(v) => updateField('category', v as TemplateCategory)}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          {(Object.keys(TEMPLATE_CATEGORY_LABELS) as TemplateCategory[]).map(
                            (cat) => (
                              <SelectItem key={cat} value={cat}>
                                <div className="flex items-center gap-2">
                                  {categoryIcons[cat]}
                                  {TEMPLATE_CATEGORY_LABELS[cat]}
                                </div>
                              </SelectItem>
                            )
                          )}
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="space-y-2">
                      <Label>Severity</Label>
                      <Select
                        value={formData.severity}
                        onValueChange={(v) => updateField('severity', v as FindingSeverity)}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          {(Object.keys(FINDING_SEVERITY_LABELS) as FindingSeverity[]).map(
                            (sev) => (
                              <SelectItem key={sev} value={sev}>
                                <div className="flex items-center gap-2">
                                  <div
                                    className={cn('w-2 h-2 rounded-full', severityColors[sev])}
                                  />
                                  {FINDING_SEVERITY_LABELS[sev]}
                                </div>
                              </SelectItem>
                            )
                          )}
                        </SelectContent>
                      </Select>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <Label>OWASP Category</Label>
                      <Select
                        value={formData.owaspCategory}
                        onValueChange={(v) => updateField('owaspCategory', v as OwaspCategory | '')}
                      >
                        <SelectTrigger>
                          <SelectValue placeholder="Select..." />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem value="">None</SelectItem>
                          {(Object.keys(OWASP_CATEGORY_LABELS) as OwaspCategory[]).map((cat) => (
                            <SelectItem key={cat} value={cat}>
                              {cat}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="space-y-2">
                      <Label htmlFor="cweId">CWE ID</Label>
                      <Input
                        id="cweId"
                        placeholder="e.g., CWE-89"
                        value={formData.cweId}
                        onChange={(e) => updateField('cweId', e.target.value)}
                      />
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Description */}
              <Card>
                <CardHeader className="pb-4">
                  <CardTitle className="text-base">
                    Description <span className="text-destructive">*</span>
                  </CardTitle>
                  <CardDescription>
                    Describe the vulnerability in detail. Supports Markdown.
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <MarkdownEditor
                    value={formData.description}
                    onChange={(v) => updateField('description', v)}
                    placeholder="Describe the vulnerability, how it occurs, and its potential impact..."
                    height={180}
                  />
                  {errors.description && (
                    <p className="text-sm text-destructive flex items-center gap-1 mt-2">
                      <AlertCircle className="h-3 w-3" />
                      {errors.description}
                    </p>
                  )}
                </CardContent>
              </Card>

              {/* Steps to Reproduce */}
              <Card>
                <CardHeader className="pb-4">
                  <CardTitle className="text-base">Steps to Reproduce</CardTitle>
                  <CardDescription>
                    Ordered list of steps to reproduce the vulnerability
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-2">
                  {formData.stepsToReproduce.map((step, index) => (
                    <div key={index} className="flex items-start gap-2">
                      <div className="flex items-center gap-2 pt-2">
                        <GripVertical className="h-4 w-4 text-muted-foreground/50" />
                        <span className="text-sm font-medium text-muted-foreground w-5">
                          {index + 1}.
                        </span>
                      </div>
                      <Textarea
                        value={step}
                        onChange={(e) => updateStep(index, e.target.value)}
                        placeholder={`Step ${index + 1}...`}
                        className="flex-1 min-h-[60px] resize-none"
                        rows={2}
                      />
                      <Button
                        type="button"
                        variant="ghost"
                        size="icon"
                        className="mt-1"
                        onClick={() => removeStep(index)}
                        disabled={formData.stepsToReproduce.length === 1}
                      >
                        <Trash2 className="h-4 w-4 text-muted-foreground" />
                      </Button>
                    </div>
                  ))}
                  <Button
                    type="button"
                    variant="outline"
                    size="sm"
                    onClick={addStep}
                    className="mt-2"
                  >
                    <Plus className="h-4 w-4 mr-2" />
                    Add Step
                  </Button>
                </CardContent>
              </Card>

              {/* Impact */}
              <Card>
                <CardHeader className="pb-4">
                  <CardTitle className="text-base">Impact Analysis</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="space-y-2">
                    <Label>Business Impact</Label>
                    <MarkdownEditor
                      value={formData.businessImpact}
                      onChange={(v) => updateField('businessImpact', v)}
                      placeholder="Describe potential business consequences..."
                      height={120}
                    />
                  </div>
                  <div className="space-y-2">
                    <Label>Technical Impact</Label>
                    <MarkdownEditor
                      value={formData.technicalImpact}
                      onChange={(v) => updateField('technicalImpact', v)}
                      placeholder="Describe technical consequences..."
                      height={120}
                    />
                  </div>
                </CardContent>
              </Card>

              {/* Remediation */}
              <Card>
                <CardHeader className="pb-4">
                  <CardTitle className="text-base">
                    Remediation <span className="text-destructive">*</span>
                  </CardTitle>
                  <CardDescription>
                    Provide guidance on how to fix this vulnerability
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <MarkdownEditor
                    value={formData.remediation}
                    onChange={(v) => updateField('remediation', v)}
                    placeholder="Describe the recommended fix and best practices..."
                    height={180}
                  />
                  {errors.remediation && (
                    <p className="text-sm text-destructive flex items-center gap-1 mt-2">
                      <AlertCircle className="h-3 w-3" />
                      {errors.remediation}
                    </p>
                  )}
                </CardContent>
              </Card>
            </div>

            {/* Sidebar */}
            <div className="space-y-6">
              {/* Summary Card */}
              <Card>
                <CardHeader className="pb-4">
                  <CardTitle className="text-base">Summary</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-muted-foreground">Severity</span>
                    <Badge className={cn('text-white', severityColors[formData.severity])}>
                      {FINDING_SEVERITY_LABELS[formData.severity]}
                    </Badge>
                  </div>
                  <Separator />
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-muted-foreground">Category</span>
                    <div className="flex items-center gap-1.5 text-sm">
                      {categoryIcons[formData.category]}
                      {TEMPLATE_CATEGORY_LABELS[formData.category]}
                    </div>
                  </div>
                  {formData.cweId && (
                    <>
                      <Separator />
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-muted-foreground">CWE ID</span>
                        <Badge variant="outline" className="font-mono">
                          {formData.cweId}
                        </Badge>
                      </div>
                    </>
                  )}
                  {formData.owaspCategory && (
                    <>
                      <Separator />
                      <div className="flex items-center justify-between">
                        <span className="text-sm text-muted-foreground">OWASP</span>
                        <Badge variant="outline">{formData.owaspCategory}</Badge>
                      </div>
                    </>
                  )}
                </CardContent>
              </Card>

              {/* Tags */}
              <Card>
                <CardHeader className="pb-4">
                  <CardTitle className="text-base">Tags</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex gap-2">
                    <Input
                      placeholder="Add tag..."
                      value={newTag}
                      onChange={(e) => setNewTag(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addTag())}
                      className="h-9"
                    />
                    <Button type="button" variant="secondary" size="sm" onClick={addTag}>
                      <Plus className="h-4 w-4" />
                    </Button>
                  </div>
                  {formData.tags.length > 0 && (
                    <div className="flex flex-wrap gap-1.5">
                      {formData.tags.map((tag) => (
                        <Badge key={tag} variant="secondary" className="gap-1 pr-1">
                          {tag}
                          <button
                            type="button"
                            onClick={() => removeTag(tag)}
                            className="ml-1 hover:text-destructive rounded-full"
                          >
                            <X className="h-3 w-3" />
                          </button>
                        </Badge>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* References */}
              <Card>
                <CardHeader className="pb-4">
                  <CardTitle className="text-base">References</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex gap-2">
                    <Input
                      placeholder="https://..."
                      value={newReference}
                      onChange={(e) => setNewReference(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addReference())}
                      className="h-9"
                    />
                    <Button type="button" variant="secondary" size="sm" onClick={addReference}>
                      <Plus className="h-4 w-4" />
                    </Button>
                  </div>
                  {formData.references.length > 0 && (
                    <div className="space-y-2">
                      {formData.references.map((ref, index) => (
                        <div
                          key={index}
                          className="flex items-center gap-2 p-2 rounded-md bg-muted text-sm"
                        >
                          <ExternalLink className="h-3.5 w-3.5 text-muted-foreground shrink-0" />
                          <a
                            href={ref}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="text-primary hover:underline truncate flex-1"
                          >
                            {ref}
                          </a>
                          <Button
                            type="button"
                            variant="ghost"
                            size="icon"
                            className="h-6 w-6 shrink-0"
                            onClick={() => removeReference(ref)}
                          >
                            <X className="h-3 w-3" />
                          </Button>
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>
            </div>
          </div>
        </div>
      </Main>
    </>
  )
}
