'use client'

import * as React from 'react'
import { useRouter, useParams } from 'next/navigation'
import { Main } from '@/components/layout'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Badge } from '@/components/ui/badge'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Skeleton } from '@/components/ui/skeleton'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from '@/components/ui/breadcrumb'
import { MarkdownEditor, MarkdownPreview } from '@/components/ui/markdown-editor'
import { cn } from '@/lib/utils'
import { toast } from 'sonner'
import { getErrorMessage } from '@/lib/api/error-handler'
import {
  ArrowLeft,
  Save,
  Eye,
  Edit3,
  Plus,
  X,
  Syringe,
  Key,
  Shield,
  Lock,
  Settings,
  Clock,
  FormInput,
  GitBranch,
  FileQuestion,
  ExternalLink,
  AlertCircle,
  Loader2,
} from 'lucide-react'
import type {
  FindingTemplate,
  TemplateCategory,
  FindingSeverity,
  OwaspCategory,
} from '@/features/pentest/types'
import {
  TEMPLATE_CATEGORY_LABELS,
  FINDING_SEVERITY_LABELS,
  OWASP_CATEGORY_LABELS,
  BUILTIN_TEMPLATES,
} from '@/features/pentest/types'

// Category icons
const categoryIcons: Record<TemplateCategory, React.ReactNode> = {
  injection: <Syringe className="h-4 w-4" />,
  authentication: <Key className="h-4 w-4" />,
  authorization: <Shield className="h-4 w-4" />,
  cryptographic: <Lock className="h-4 w-4" />,
  configuration: <Settings className="h-4 w-4" />,
  disclosure: <Eye className="h-4 w-4" />,
  session: <Clock className="h-4 w-4" />,
  input_validation: <FormInput className="h-4 w-4" />,
  logic: <GitBranch className="h-4 w-4" />,
  other: <FileQuestion className="h-4 w-4" />,
}

// Severity colors
const severityColors: Record<FindingSeverity, string> = {
  critical: 'bg-red-500',
  high: 'bg-orange-500',
  medium: 'bg-yellow-500',
  low: 'bg-blue-500',
  info: 'bg-gray-400',
}

interface FormData {
  name: string
  category: TemplateCategory
  severity: FindingSeverity
  owaspCategory: OwaspCategory | ''
  cweId: string
  description: string
  stepsToReproduce: string
  businessImpact: string
  technicalImpact: string
  remediation: string
  references: string[]
  tags: string[]
}

export default function EditTemplatePage() {
  const router = useRouter()
  const params = useParams()
  const templateId = params.id as string

  const [isLoading, setIsLoading] = React.useState(true)
  const [formData, setFormData] = React.useState<FormData | null>(null)
  const [newTag, setNewTag] = React.useState('')
  const [newReference, setNewReference] = React.useState('')
  const [activeTab, setActiveTab] = React.useState('basic')
  const [isSaving, setIsSaving] = React.useState(false)
  const [errors, setErrors] = React.useState<Record<string, string>>({})

  // Load template data
  React.useEffect(() => {
    const loadTemplate = async () => {
      setIsLoading(true)
      try {
        // TODO: Replace with actual API call
        await new Promise((resolve) => setTimeout(resolve, 500))

        // Mock: find template from builtin templates
        const index = parseInt(templateId.replace('builtin-', '')) - 1
        const template = BUILTIN_TEMPLATES[index]

        if (template) {
          setFormData({
            name: template.name || '',
            category: template.category || 'other',
            severity: template.severity || 'medium',
            owaspCategory: template.owaspCategory || '',
            cweId: template.cweId || '',
            description: template.description || '',
            stepsToReproduce: template.stepsToReproduce?.join('\n') || '',
            businessImpact: template.businessImpact || '',
            technicalImpact: template.technicalImpact || '',
            remediation: template.remediation || '',
            references: template.references || [],
            tags: template.tags || [],
          })
        } else {
          toast.error(getErrorMessage(undefined, 'Template not found'))
          router.push('/pentest/templates')
        }
      } catch (err) {
        toast.error(getErrorMessage(err, 'Failed to load template'))
        router.push('/pentest/templates')
      } finally {
        setIsLoading(false)
      }
    }

    loadTemplate()
  }, [templateId, router])

  const updateField = <K extends keyof FormData>(field: K, value: FormData[K]) => {
    if (!formData) return
    setFormData((prev) => (prev ? { ...prev, [field]: value } : null))
    if (errors[field]) {
      setErrors((prev) => {
        const newErrors = { ...prev }
        delete newErrors[field]
        return newErrors
      })
    }
  }

  const addTag = () => {
    if (!formData) return
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      updateField('tags', [...formData.tags, newTag.trim()])
      setNewTag('')
    }
  }

  const removeTag = (tag: string) => {
    if (!formData) return
    updateField(
      'tags',
      formData.tags.filter((t) => t !== tag)
    )
  }

  const addReference = () => {
    if (!formData) return
    if (newReference.trim() && !formData.references.includes(newReference.trim())) {
      updateField('references', [...formData.references, newReference.trim()])
      setNewReference('')
    }
  }

  const removeReference = (ref: string) => {
    if (!formData) return
    updateField(
      'references',
      formData.references.filter((r) => r !== ref)
    )
  }

  const validate = (): boolean => {
    if (!formData) return false
    const newErrors: Record<string, string> = {}

    if (!formData.name.trim()) {
      newErrors.name = 'Template name is required'
    }
    if (!formData.description.trim()) {
      newErrors.description = 'Description is required'
    }
    if (!formData.remediation.trim()) {
      newErrors.remediation = 'Remediation guidance is required'
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  const handleSave = async () => {
    if (!formData || !validate()) {
      toast.error('Please fill in all required fields')
      return
    }

    setIsSaving(true)
    try {
      // TODO: Replace with actual API call
      await new Promise((resolve) => setTimeout(resolve, 1000))

      const template: Partial<FindingTemplate> = {
        ...formData,
        owaspCategory: formData.owaspCategory || undefined,
        stepsToReproduce: formData.stepsToReproduce.split('\n').filter((s) => s.trim()),
      }

      console.log('Updating template:', template)
      toast.success('Template updated successfully')
      router.push('/pentest/templates')
    } catch (err) {
      toast.error(getErrorMessage(err, 'Failed to update template'))
    } finally {
      setIsSaving(false)
    }
  }

  const handleCancel = () => {
    router.push('/pentest/templates')
  }

  if (isLoading) {
    return (
      <>
        <Main>
          <div className="flex flex-col gap-6">
            <Skeleton className="h-8 w-48" />
            <Skeleton className="h-12 w-full" />
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div className="lg:col-span-2 space-y-6">
                <Skeleton className="h-[400px] w-full" />
              </div>
              <div className="space-y-6">
                <Skeleton className="h-[200px] w-full" />
                <Skeleton className="h-[150px] w-full" />
              </div>
            </div>
          </div>
        </Main>
      </>
    )
  }

  if (!formData) {
    return null
  }

  return (
    <>
      <Main>
        <div className="flex flex-col gap-6">
          {/* Breadcrumb */}
          <Breadcrumb>
            <BreadcrumbList>
              <BreadcrumbItem>
                <BreadcrumbLink href="/pentest/templates">Templates</BreadcrumbLink>
              </BreadcrumbItem>
              <BreadcrumbSeparator />
              <BreadcrumbItem>
                <BreadcrumbPage>Edit Template</BreadcrumbPage>
              </BreadcrumbItem>
            </BreadcrumbList>
          </Breadcrumb>

          {/* Header */}
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <Button variant="ghost" size="icon" onClick={handleCancel}>
                <ArrowLeft className="h-4 w-4" />
              </Button>
              <div>
                <h1 className="text-2xl font-bold">Edit Template</h1>
                <p className="text-muted-foreground">Update the finding template details</p>
              </div>
            </div>
            <div className="flex gap-2">
              <Button variant="outline" onClick={handleCancel}>
                Cancel
              </Button>
              <Button onClick={handleSave} disabled={isSaving}>
                {isSaving ? (
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                ) : (
                  <Save className="h-4 w-4 mr-2" />
                )}
                {isSaving ? 'Saving...' : 'Save Changes'}
              </Button>
            </div>
          </div>

          {/* Form */}
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Main Content */}
            <div className="lg:col-span-2 space-y-6">
              <Tabs value={activeTab} onValueChange={setActiveTab}>
                <TabsList className="grid w-full grid-cols-3">
                  <TabsTrigger value="basic">
                    <Edit3 className="h-4 w-4 mr-2" />
                    Basic Info
                  </TabsTrigger>
                  <TabsTrigger value="details">
                    <FileQuestion className="h-4 w-4 mr-2" />
                    Details
                  </TabsTrigger>
                  <TabsTrigger value="preview">
                    <Eye className="h-4 w-4 mr-2" />
                    Preview
                  </TabsTrigger>
                </TabsList>

                <TabsContent value="basic" className="space-y-6 mt-6">
                  {/* Template Name */}
                  <Card>
                    <CardHeader>
                      <CardTitle>Template Information</CardTitle>
                      <CardDescription>
                        Basic information about the vulnerability template
                      </CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="space-y-2">
                        <Label htmlFor="name">
                          Template Name <span className="text-destructive">*</span>
                        </Label>
                        <Input
                          id="name"
                          placeholder="e.g., SQL Injection in Login Form"
                          value={formData.name}
                          onChange={(e) => updateField('name', e.target.value)}
                          className={errors.name ? 'border-destructive' : ''}
                        />
                        {errors.name && (
                          <p className="text-sm text-destructive flex items-center gap-1">
                            <AlertCircle className="h-3 w-3" />
                            {errors.name}
                          </p>
                        )}
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div className="space-y-2">
                          <Label>Category</Label>
                          <Select
                            value={formData.category}
                            onValueChange={(v) => updateField('category', v as TemplateCategory)}
                          >
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              {(Object.keys(TEMPLATE_CATEGORY_LABELS) as TemplateCategory[]).map(
                                (cat) => (
                                  <SelectItem key={cat} value={cat}>
                                    <div className="flex items-center gap-2">
                                      {categoryIcons[cat]}
                                      {TEMPLATE_CATEGORY_LABELS[cat]}
                                    </div>
                                  </SelectItem>
                                )
                              )}
                            </SelectContent>
                          </Select>
                        </div>

                        <div className="space-y-2">
                          <Label>Severity</Label>
                          <Select
                            value={formData.severity}
                            onValueChange={(v) => updateField('severity', v as FindingSeverity)}
                          >
                            <SelectTrigger>
                              <SelectValue />
                            </SelectTrigger>
                            <SelectContent>
                              {(Object.keys(FINDING_SEVERITY_LABELS) as FindingSeverity[]).map(
                                (sev) => (
                                  <SelectItem key={sev} value={sev}>
                                    <div className="flex items-center gap-2">
                                      <div
                                        className={cn('w-2 h-2 rounded-full', severityColors[sev])}
                                      />
                                      {FINDING_SEVERITY_LABELS[sev]}
                                    </div>
                                  </SelectItem>
                                )
                              )}
                            </SelectContent>
                          </Select>
                        </div>
                      </div>

                      <div className="grid grid-cols-2 gap-4">
                        <div className="space-y-2">
                          <Label>OWASP Category</Label>
                          <Select
                            value={formData.owaspCategory}
                            onValueChange={(v) =>
                              updateField('owaspCategory', v as OwaspCategory | '')
                            }
                          >
                            <SelectTrigger>
                              <SelectValue placeholder="Select OWASP category" />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="">None</SelectItem>
                              {(Object.keys(OWASP_CATEGORY_LABELS) as OwaspCategory[]).map(
                                (cat) => (
                                  <SelectItem key={cat} value={cat}>
                                    {cat}: {OWASP_CATEGORY_LABELS[cat]}
                                  </SelectItem>
                                )
                              )}
                            </SelectContent>
                          </Select>
                        </div>

                        <div className="space-y-2">
                          <Label htmlFor="cweId">CWE ID</Label>
                          <Input
                            id="cweId"
                            placeholder="e.g., CWE-89"
                            value={formData.cweId}
                            onChange={(e) => updateField('cweId', e.target.value)}
                          />
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  {/* Description */}
                  <Card>
                    <CardHeader>
                      <CardTitle>
                        Description <span className="text-destructive">*</span>
                      </CardTitle>
                      <CardDescription>
                        Describe the vulnerability in detail. Supports Markdown formatting.
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      <MarkdownEditor
                        value={formData.description}
                        onChange={(v) => updateField('description', v)}
                        placeholder="Describe the vulnerability, how it occurs, and its potential impact..."
                        height={200}
                        preview="edit"
                      />
                      {errors.description && (
                        <p className="text-sm text-destructive flex items-center gap-1 mt-2">
                          <AlertCircle className="h-3 w-3" />
                          {errors.description}
                        </p>
                      )}
                    </CardContent>
                  </Card>
                </TabsContent>

                <TabsContent value="details" className="space-y-6 mt-6">
                  {/* Steps to Reproduce */}
                  <Card>
                    <CardHeader>
                      <CardTitle>Steps to Reproduce</CardTitle>
                      <CardDescription>
                        Step-by-step instructions to reproduce the vulnerability
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      <MarkdownEditor
                        value={formData.stepsToReproduce}
                        onChange={(v) => updateField('stepsToReproduce', v)}
                        placeholder="1. Navigate to the login page&#10;2. Enter a single quote in the username field&#10;3. Observe the SQL error message..."
                        height={200}
                        preview="edit"
                      />
                    </CardContent>
                  </Card>

                  {/* Impact */}
                  <Card>
                    <CardHeader>
                      <CardTitle>Impact Analysis</CardTitle>
                      <CardDescription>Describe the business and technical impact</CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="space-y-2">
                        <Label>Business Impact</Label>
                        <MarkdownEditor
                          value={formData.businessImpact}
                          onChange={(v) => updateField('businessImpact', v)}
                          placeholder="Describe the potential business consequences..."
                          height={150}
                          preview="edit"
                        />
                      </div>
                      <div className="space-y-2">
                        <Label>Technical Impact</Label>
                        <MarkdownEditor
                          value={formData.technicalImpact}
                          onChange={(v) => updateField('technicalImpact', v)}
                          placeholder="Describe the technical consequences..."
                          height={150}
                          preview="edit"
                        />
                      </div>
                    </CardContent>
                  </Card>

                  {/* Remediation */}
                  <Card>
                    <CardHeader>
                      <CardTitle>
                        Remediation <span className="text-destructive">*</span>
                      </CardTitle>
                      <CardDescription>
                        Provide guidance on how to fix this vulnerability
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      <MarkdownEditor
                        value={formData.remediation}
                        onChange={(v) => updateField('remediation', v)}
                        placeholder="Describe the recommended fix and best practices..."
                        height={200}
                        preview="edit"
                      />
                      {errors.remediation && (
                        <p className="text-sm text-destructive flex items-center gap-1 mt-2">
                          <AlertCircle className="h-3 w-3" />
                          {errors.remediation}
                        </p>
                      )}
                    </CardContent>
                  </Card>

                  {/* References */}
                  <Card>
                    <CardHeader>
                      <CardTitle>References</CardTitle>
                      <CardDescription>
                        Add links to relevant documentation, CVEs, or articles
                      </CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="flex gap-2">
                        <Input
                          placeholder="https://example.com/reference"
                          value={newReference}
                          onChange={(e) => setNewReference(e.target.value)}
                          onKeyDown={(e) =>
                            e.key === 'Enter' && (e.preventDefault(), addReference())
                          }
                        />
                        <Button type="button" variant="secondary" onClick={addReference}>
                          <Plus className="h-4 w-4" />
                        </Button>
                      </div>
                      {formData.references.length > 0 && (
                        <div className="space-y-2">
                          {formData.references.map((ref, index) => (
                            <div
                              key={index}
                              className="flex items-center gap-2 p-2 rounded-md bg-muted"
                            >
                              <ExternalLink className="h-4 w-4 text-muted-foreground shrink-0" />
                              <a
                                href={ref}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-sm text-primary hover:underline truncate flex-1"
                              >
                                {ref}
                              </a>
                              <Button
                                type="button"
                                variant="ghost"
                                size="icon"
                                className="h-6 w-6 shrink-0"
                                onClick={() => removeReference(ref)}
                              >
                                <X className="h-3 w-3" />
                              </Button>
                            </div>
                          ))}
                        </div>
                      )}
                    </CardContent>
                  </Card>
                </TabsContent>

                <TabsContent value="preview" className="mt-6">
                  <Card>
                    <CardHeader>
                      <div className="flex items-center gap-3">
                        <div
                          className={cn(
                            'w-1.5 h-12 rounded-full',
                            severityColors[formData.severity]
                          )}
                        />
                        <div>
                          <CardTitle>{formData.name || 'Untitled Template'}</CardTitle>
                          <CardDescription className="flex items-center gap-2 mt-1">
                            {categoryIcons[formData.category]}
                            {TEMPLATE_CATEGORY_LABELS[formData.category]}
                            {formData.cweId && (
                              <>
                                <span className="text-muted-foreground">|</span>
                                <Badge variant="outline" className="font-mono">
                                  {formData.cweId}
                                </Badge>
                              </>
                            )}
                            {formData.owaspCategory && (
                              <>
                                <span className="text-muted-foreground">|</span>
                                <Badge variant="outline">{formData.owaspCategory}</Badge>
                              </>
                            )}
                          </CardDescription>
                        </div>
                      </div>
                    </CardHeader>
                    <CardContent className="space-y-6">
                      {formData.description && (
                        <div>
                          <h4 className="font-semibold mb-2">Description</h4>
                          <MarkdownPreview content={formData.description} />
                        </div>
                      )}

                      {formData.stepsToReproduce && (
                        <div>
                          <h4 className="font-semibold mb-2">Steps to Reproduce</h4>
                          <MarkdownPreview content={formData.stepsToReproduce} />
                        </div>
                      )}

                      {(formData.businessImpact || formData.technicalImpact) && (
                        <div>
                          <h4 className="font-semibold mb-2">Impact</h4>
                          {formData.businessImpact && (
                            <div className="mb-2">
                              <span className="text-sm font-medium text-muted-foreground">
                                Business:{' '}
                              </span>
                              <MarkdownPreview content={formData.businessImpact} />
                            </div>
                          )}
                          {formData.technicalImpact && (
                            <div>
                              <span className="text-sm font-medium text-muted-foreground">
                                Technical:{' '}
                              </span>
                              <MarkdownPreview content={formData.technicalImpact} />
                            </div>
                          )}
                        </div>
                      )}

                      {formData.remediation && (
                        <div>
                          <h4 className="font-semibold mb-2">Remediation</h4>
                          <MarkdownPreview content={formData.remediation} />
                        </div>
                      )}

                      {formData.references.length > 0 && (
                        <div>
                          <h4 className="font-semibold mb-2">References</h4>
                          <ul className="list-disc list-inside space-y-1">
                            {formData.references.map((ref, index) => (
                              <li key={index}>
                                <a
                                  href={ref}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  className="text-sm text-primary hover:underline"
                                >
                                  {ref}
                                </a>
                              </li>
                            ))}
                          </ul>
                        </div>
                      )}

                      {formData.tags.length > 0 && (
                        <div>
                          <h4 className="font-semibold mb-2">Tags</h4>
                          <div className="flex flex-wrap gap-1">
                            {formData.tags.map((tag) => (
                              <Badge key={tag} variant="secondary">
                                {tag}
                              </Badge>
                            ))}
                          </div>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                </TabsContent>
              </Tabs>
            </div>

            {/* Sidebar */}
            <div className="space-y-6">
              {/* Quick Info Card */}
              <Card>
                <CardHeader>
                  <CardTitle>Summary</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-muted-foreground">Severity</span>
                    <Badge className={cn('text-white', severityColors[formData.severity])}>
                      {FINDING_SEVERITY_LABELS[formData.severity]}
                    </Badge>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-sm text-muted-foreground">Category</span>
                    <div className="flex items-center gap-1.5 text-sm">
                      {categoryIcons[formData.category]}
                      {TEMPLATE_CATEGORY_LABELS[formData.category]}
                    </div>
                  </div>
                  {formData.cweId && (
                    <div className="flex items-center justify-between">
                      <span className="text-sm text-muted-foreground">CWE ID</span>
                      <Badge variant="outline" className="font-mono">
                        {formData.cweId}
                      </Badge>
                    </div>
                  )}
                  {formData.owaspCategory && (
                    <div className="flex items-center justify-between">
                      <span className="text-sm text-muted-foreground">OWASP</span>
                      <Badge variant="outline">{formData.owaspCategory}</Badge>
                    </div>
                  )}
                </CardContent>
              </Card>

              {/* Tags */}
              <Card>
                <CardHeader>
                  <CardTitle>Tags</CardTitle>
                  <CardDescription>Add tags to help organize templates</CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex gap-2">
                    <Input
                      placeholder="Add tag..."
                      value={newTag}
                      onChange={(e) => setNewTag(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && (e.preventDefault(), addTag())}
                    />
                    <Button type="button" variant="secondary" size="icon" onClick={addTag}>
                      <Plus className="h-4 w-4" />
                    </Button>
                  </div>
                  {formData.tags.length > 0 && (
                    <div className="flex flex-wrap gap-1">
                      {formData.tags.map((tag) => (
                        <Badge key={tag} variant="secondary" className="gap-1">
                          {tag}
                          <button
                            type="button"
                            onClick={() => removeTag(tag)}
                            className="ml-1 hover:text-destructive"
                          >
                            <X className="h-3 w-3" />
                          </button>
                        </Badge>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>
            </div>
          </div>
        </div>
      </Main>
    </>
  )
}
