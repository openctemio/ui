'use client'

import * as React from 'react'
import { useRouter } from 'next/navigation'
import { Main } from '@/components/layout'
import { Button } from '@/components/ui/button'
import { Card, CardContent } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Input } from '@/components/ui/input'
import { Checkbox } from '@/components/ui/checkbox'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { TooltipProvider } from '@/components/ui/tooltip'
import { cn } from '@/lib/utils'
import { toast } from 'sonner'
import {
  Plus,
  Search,
  BookTemplate,
  Star,
  Users,
  Syringe,
  Key,
  Shield,
  Lock,
  Settings,
  Eye,
  Clock,
  FormInput,
  GitBranch,
  FileQuestion,
  Copy,
  Edit2,
  Trash2,
  MoreHorizontal,
  LayoutGrid,
  List,
  ChevronLeft,
  ChevronRight,
  ChevronsLeft,
  ChevronsRight,
  ArrowUpDown,
  ArrowUp,
  ArrowDown,
  Download,
  Upload,
  X,
} from 'lucide-react'
import { Can, Permission } from '@/lib/permissions'
import { TemplateDetailSheet } from '@/features/pentest/components'
import type { FindingTemplate, TemplateCategory, FindingSeverity } from '@/features/pentest/types'
import {
  TEMPLATE_CATEGORY_LABELS,
  FINDING_SEVERITY_LABELS,
  BUILTIN_TEMPLATES,
} from '@/features/pentest/types'

// Category icons
const categoryIcons: Record<TemplateCategory, React.ReactNode> = {
  injection: <Syringe className="h-4 w-4" />,
  authentication: <Key className="h-4 w-4" />,
  authorization: <Shield className="h-4 w-4" />,
  cryptographic: <Lock className="h-4 w-4" />,
  configuration: <Settings className="h-4 w-4" />,
  disclosure: <Eye className="h-4 w-4" />,
  session: <Clock className="h-4 w-4" />,
  input_validation: <FormInput className="h-4 w-4" />,
  logic: <GitBranch className="h-4 w-4" />,
  other: <FileQuestion className="h-4 w-4" />,
}

// Severity colors and order
const severityColors: Record<FindingSeverity, string> = {
  critical: 'bg-red-500',
  high: 'bg-orange-500',
  medium: 'bg-yellow-500',
  low: 'bg-blue-500',
  info: 'bg-gray-400',
}

const severityOrder: Record<FindingSeverity, number> = {
  critical: 0,
  high: 1,
  medium: 2,
  low: 3,
  info: 4,
}

const severityBadgeStyles: Record<FindingSeverity, string> = {
  critical: 'bg-red-100 text-red-700 dark:bg-red-950 dark:text-red-400',
  high: 'bg-orange-100 text-orange-700 dark:bg-orange-950 dark:text-orange-400',
  medium: 'bg-yellow-100 text-yellow-700 dark:bg-yellow-950 dark:text-yellow-400',
  low: 'bg-blue-100 text-blue-700 dark:bg-blue-950 dark:text-blue-400',
  info: 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400',
}

// Generate templates from builtin data
const generateFullTemplates = (): FindingTemplate[] => {
  return BUILTIN_TEMPLATES.map((template, index) => ({
    id: `builtin-${index + 1}`,
    name: template.name || '',
    category: template.category || 'other',
    severity: template.severity || 'medium',
    owaspCategory: template.owaspCategory,
    cweId: template.cweId,
    description: template.description || '',
    stepsToReproduce: template.stepsToReproduce || [],
    businessImpact: template.businessImpact || '',
    technicalImpact: template.technicalImpact || '',
    remediation: template.remediation || '',
    references: template.references || [],
    tags: template.tags || [],
    isBuiltIn: true,
    createdAt: '2024-01-01T00:00:00Z',
    updatedAt: '2024-01-01T00:00:00Z',
    usageCount: Math.floor(Math.random() * 50) + 10,
  }))
}

const PAGE_SIZE_OPTIONS = [10, 25, 50]

type SortField = 'name' | 'category' | 'severity' | 'usageCount'
type SortDirection = 'asc' | 'desc'

export default function PentestTemplatesPage() {
  const router = useRouter()
  const [templates, setTemplates] = React.useState<FindingTemplate[]>(() => generateFullTemplates())
  const [searchQuery, setSearchQuery] = React.useState('')
  const [filterCategory, setFilterCategory] = React.useState<string>('all')
  const [filterSeverity, setFilterSeverity] = React.useState<string>('all')
  const [filterType, setFilterType] = React.useState<string>('all')
  const [viewMode, setViewMode] = React.useState<'grid' | 'table'>('table')
  const [selectedTemplate, setSelectedTemplate] = React.useState<FindingTemplate | null>(null)
  const [detailSheetOpen, setDetailSheetOpen] = React.useState(false)
  const [deleteDialogOpen, setDeleteDialogOpen] = React.useState(false)
  const [templateToDelete, setTemplateToDelete] = React.useState<FindingTemplate | null>(null)

  // Sorting
  const [sortField, setSortField] = React.useState<SortField>('name')
  const [sortDirection, setSortDirection] = React.useState<SortDirection>('asc')

  // Selection
  const [selectedIds, setSelectedIds] = React.useState<Set<string>>(new Set())

  // Pagination
  const [currentPage, setCurrentPage] = React.useState(1)
  const [pageSize, setPageSize] = React.useState(10)

  // Filter and sort
  const filteredAndSortedTemplates = React.useMemo(() => {
    const result = templates.filter((t) => {
      const matchesSearch =
        t.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
        t.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
        t.cweId?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        t.tags.some((tag) => tag.toLowerCase().includes(searchQuery.toLowerCase()))
      const matchesCategory = filterCategory === 'all' || t.category === filterCategory
      const matchesSeverity = filterSeverity === 'all' || t.severity === filterSeverity
      const matchesType =
        filterType === 'all' ||
        (filterType === 'builtin' && t.isBuiltIn) ||
        (filterType === 'custom' && !t.isBuiltIn)
      return matchesSearch && matchesCategory && matchesSeverity && matchesType
    })

    // Sort
    result.sort((a, b) => {
      let comparison = 0
      switch (sortField) {
        case 'name':
          comparison = a.name.localeCompare(b.name)
          break
        case 'category':
          comparison = a.category.localeCompare(b.category)
          break
        case 'severity':
          comparison = severityOrder[a.severity] - severityOrder[b.severity]
          break
        case 'usageCount':
          comparison = a.usageCount - b.usageCount
          break
      }
      return sortDirection === 'asc' ? comparison : -comparison
    })

    return result
  }, [templates, searchQuery, filterCategory, filterSeverity, filterType, sortField, sortDirection])

  // Reset page when filters change
  React.useEffect(() => {
    setCurrentPage(1)
    setSelectedIds(new Set())
  }, [searchQuery, filterCategory, filterSeverity, filterType])

  // Pagination
  const totalPages = Math.ceil(filteredAndSortedTemplates.length / pageSize)
  const startIndex = (currentPage - 1) * pageSize
  const paginatedTemplates = filteredAndSortedTemplates.slice(startIndex, startIndex + pageSize)

  const stats = React.useMemo(
    () => ({
      total: templates.length,
      builtIn: templates.filter((t) => t.isBuiltIn).length,
      custom: templates.filter((t) => !t.isBuiltIn).length,
    }),
    [templates]
  )

  // Handlers
  const handleSort = (field: SortField) => {
    if (sortField === field) {
      setSortDirection((prev) => (prev === 'asc' ? 'desc' : 'asc'))
    } else {
      setSortField(field)
      setSortDirection('asc')
    }
  }

  const getSortIcon = (field: SortField) => {
    if (sortField !== field) return <ArrowUpDown className="h-4 w-4 ml-1 opacity-50" />
    return sortDirection === 'asc' ? (
      <ArrowUp className="h-4 w-4 ml-1" />
    ) : (
      <ArrowDown className="h-4 w-4 ml-1" />
    )
  }

  const handleSelectAll = (checked: boolean) => {
    if (checked) {
      setSelectedIds(new Set(paginatedTemplates.map((t) => t.id)))
    } else {
      setSelectedIds(new Set())
    }
  }

  const handleSelectOne = (id: string, checked: boolean) => {
    const newSet = new Set(selectedIds)
    if (checked) {
      newSet.add(id)
    } else {
      newSet.delete(id)
    }
    setSelectedIds(newSet)
  }

  const handleBulkDelete = () => {
    const customSelected = Array.from(selectedIds).filter((id) => {
      const template = templates.find((t) => t.id === id)
      return template && !template.isBuiltIn
    })

    if (customSelected.length === 0) {
      toast.error('Cannot delete built-in templates')
      return
    }

    setTemplates((prev) => prev.filter((t) => !customSelected.includes(t.id)))
    setSelectedIds(new Set())
    toast.success(`Deleted ${customSelected.length} template(s)`)
  }

  const handleExport = () => {
    const selectedTemplates = templates.filter((t) => selectedIds.has(t.id))
    const data = JSON.stringify(selectedTemplates, null, 2)
    const blob = new Blob([data], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `templates-export-${new Date().toISOString().split('T')[0]}.json`
    a.click()
    URL.revokeObjectURL(url)
    toast.success(`Exported ${selectedTemplates.length} template(s)`)
  }

  const handleCreate = () => {
    router.push('/pentest/templates/new')
  }

  const handleEdit = (template: FindingTemplate) => {
    router.push(`/pentest/templates/${template.id}/edit`)
    setDetailSheetOpen(false)
  }

  const handleDuplicate = (template: FindingTemplate) => {
    router.push(`/pentest/templates/new?duplicate=${template.id}`)
    setDetailSheetOpen(false)
  }

  const handleView = (template: FindingTemplate) => {
    setSelectedTemplate(template)
    setDetailSheetOpen(true)
  }

  const handleDelete = (template: FindingTemplate) => {
    setTemplateToDelete(template)
    setDeleteDialogOpen(true)
  }

  const confirmDelete = () => {
    if (templateToDelete) {
      setTemplates((prev) => prev.filter((t) => t.id !== templateToDelete.id))
      setTemplateToDelete(null)
      setDeleteDialogOpen(false)
      toast.success('Template deleted')
    }
  }

  const clearFilters = () => {
    setSearchQuery('')
    setFilterCategory('all')
    setFilterSeverity('all')
    setFilterType('all')
  }

  const hasActiveFilters =
    searchQuery || filterCategory !== 'all' || filterSeverity !== 'all' || filterType !== 'all'

  return (
    <>
      <Main>
        <TooltipProvider>
          <div className="flex flex-col gap-4">
            {/* Header with inline stats */}
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
              <div>
                <h1 className="text-2xl font-bold tracking-tight">Finding Templates</h1>
                <p className="text-muted-foreground text-sm">
                  {stats.total} templates
                  <span className="mx-2 text-muted-foreground/30">|</span>
                  <Star className="inline h-3.5 w-3.5 text-yellow-500 mr-1" />
                  {stats.builtIn} built-in
                  <span className="mx-2 text-muted-foreground/30">|</span>
                  <Users className="inline h-3.5 w-3.5 mr-1" />
                  {stats.custom} custom
                </p>
              </div>
              <div className="flex items-center gap-2">
                <Button variant="outline" size="sm" className="hidden sm:flex">
                  <Upload className="h-4 w-4 mr-2" />
                  Import
                </Button>
                <Can permission={Permission.PentestWrite} mode="disable">
                  <Button onClick={handleCreate} className="flex-1 sm:flex-none">
                    <Plus className="h-4 w-4 mr-2" />
                    New Template
                  </Button>
                </Can>
              </div>
            </div>

            {/* Filters Bar */}
            <Card>
              <CardContent className="py-3">
                <div className="flex flex-col gap-3">
                  {/* Search and View Toggle */}
                  <div className="flex items-center gap-3">
                    <div className="relative flex-1">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                      <Input
                        placeholder="Search templates..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="pl-9 h-9"
                      />
                    </div>
                    <div className="flex border rounded-md">
                      <Button
                        variant={viewMode === 'table' ? 'secondary' : 'ghost'}
                        size="icon"
                        className="h-9 w-9 rounded-r-none"
                        onClick={() => setViewMode('table')}
                      >
                        <List className="h-4 w-4" />
                      </Button>
                      <Button
                        variant={viewMode === 'grid' ? 'secondary' : 'ghost'}
                        size="icon"
                        className="h-9 w-9 rounded-l-none"
                        onClick={() => setViewMode('grid')}
                      >
                        <LayoutGrid className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                  {/* Filters */}
                  <div className="flex flex-wrap items-center gap-2">
                    <Select value={filterType} onValueChange={setFilterType}>
                      <SelectTrigger className="w-[120px] h-9">
                        <SelectValue placeholder="Type" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">All Types</SelectItem>
                        <SelectItem value="builtin">Built-in</SelectItem>
                        <SelectItem value="custom">Custom</SelectItem>
                      </SelectContent>
                    </Select>
                    <Select value={filterCategory} onValueChange={setFilterCategory}>
                      <SelectTrigger className="w-[150px] h-9">
                        <SelectValue placeholder="Category" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">All Categories</SelectItem>
                        {(Object.keys(TEMPLATE_CATEGORY_LABELS) as TemplateCategory[]).map(
                          (cat) => (
                            <SelectItem key={cat} value={cat}>
                              <div className="flex items-center gap-2">
                                {categoryIcons[cat]}
                                {TEMPLATE_CATEGORY_LABELS[cat]}
                              </div>
                            </SelectItem>
                          )
                        )}
                      </SelectContent>
                    </Select>
                    <Select value={filterSeverity} onValueChange={setFilterSeverity}>
                      <SelectTrigger className="w-[130px] h-9">
                        <SelectValue placeholder="Severity" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">All Severities</SelectItem>
                        {(Object.keys(FINDING_SEVERITY_LABELS) as FindingSeverity[]).map((sev) => (
                          <SelectItem key={sev} value={sev}>
                            <div className="flex items-center gap-2">
                              <div className={cn('w-2 h-2 rounded-full', severityColors[sev])} />
                              {FINDING_SEVERITY_LABELS[sev]}
                            </div>
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    {hasActiveFilters && (
                      <Button variant="ghost" size="sm" onClick={clearFilters} className="h-9 px-2">
                        <X className="h-4 w-4 mr-1" />
                        Clear
                      </Button>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Bulk Actions Bar */}
            {selectedIds.size > 0 && (
              <div className="flex items-center gap-3 px-4 py-2 bg-muted rounded-lg">
                <span className="text-sm font-medium">{selectedIds.size} selected</span>
                <div className="flex-1" />
                <Button variant="outline" size="sm" onClick={handleExport}>
                  <Download className="h-4 w-4 mr-2" />
                  Export
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  className="text-destructive"
                  onClick={handleBulkDelete}
                >
                  <Trash2 className="h-4 w-4 mr-2" />
                  Delete
                </Button>
                <Button variant="ghost" size="sm" onClick={() => setSelectedIds(new Set())}>
                  <X className="h-4 w-4" />
                </Button>
              </div>
            )}

            {/* Content */}
            {filteredAndSortedTemplates.length === 0 ? (
              <Card className="border-dashed">
                <CardContent className="py-12 text-center">
                  <BookTemplate className="h-12 w-12 mx-auto text-muted-foreground/50 mb-4" />
                  <h3 className="text-lg font-semibold mb-1">No Templates Found</h3>
                  <p className="text-sm text-muted-foreground mb-4">
                    {hasActiveFilters
                      ? 'Try adjusting your search or filters.'
                      : 'Create your first custom template to get started.'}
                  </p>
                  {hasActiveFilters ? (
                    <Button variant="outline" onClick={clearFilters}>
                      Clear Filters
                    </Button>
                  ) : (
                    <Button onClick={handleCreate}>
                      <Plus className="h-4 w-4 mr-2" />
                      Create Template
                    </Button>
                  )}
                </CardContent>
              </Card>
            ) : viewMode === 'table' ? (
              <Card>
                <CardContent className="p-0">
                  <div className="overflow-x-auto">
                    <Table>
                      <TableHeader>
                        <TableRow>
                          <TableHead className="w-[40px]">
                            <Checkbox
                              checked={
                                paginatedTemplates.length > 0 &&
                                paginatedTemplates.every((t) => selectedIds.has(t.id))
                              }
                              onCheckedChange={handleSelectAll}
                            />
                          </TableHead>
                          <TableHead
                            className="cursor-pointer hover:bg-muted/50"
                            onClick={() => handleSort('name')}
                          >
                            <div className="flex items-center">
                              Name
                              {getSortIcon('name')}
                            </div>
                          </TableHead>
                          <TableHead
                            className="cursor-pointer hover:bg-muted/50"
                            onClick={() => handleSort('category')}
                          >
                            <div className="flex items-center">
                              Category
                              {getSortIcon('category')}
                            </div>
                          </TableHead>
                          <TableHead
                            className="cursor-pointer hover:bg-muted/50"
                            onClick={() => handleSort('severity')}
                          >
                            <div className="flex items-center">
                              Severity
                              {getSortIcon('severity')}
                            </div>
                          </TableHead>
                          <TableHead>CWE</TableHead>
                          <TableHead>Type</TableHead>
                          <TableHead
                            className="text-right cursor-pointer hover:bg-muted/50"
                            onClick={() => handleSort('usageCount')}
                          >
                            <div className="flex items-center justify-end">
                              Usage
                              {getSortIcon('usageCount')}
                            </div>
                          </TableHead>
                          <TableHead className="w-[50px]"></TableHead>
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {paginatedTemplates.map((template) => (
                          <TableRow
                            key={template.id}
                            className={cn(
                              'cursor-pointer',
                              selectedIds.has(template.id) && 'bg-muted/50'
                            )}
                            onClick={() => handleView(template)}
                          >
                            <TableCell onClick={(e) => e.stopPropagation()}>
                              <Checkbox
                                checked={selectedIds.has(template.id)}
                                onCheckedChange={(checked) =>
                                  handleSelectOne(template.id, checked as boolean)
                                }
                              />
                            </TableCell>
                            <TableCell>
                              <div className="flex items-center gap-3">
                                <div
                                  className={cn(
                                    'w-1 h-8 rounded-full',
                                    severityColors[template.severity]
                                  )}
                                />
                                <div className="min-w-0">
                                  <p className="font-medium truncate max-w-[280px]">
                                    {template.name}
                                  </p>
                                  <p className="text-xs text-muted-foreground truncate max-w-[280px]">
                                    {template.description}
                                  </p>
                                </div>
                              </div>
                            </TableCell>
                            <TableCell>
                              <div className="flex items-center gap-1.5 text-muted-foreground">
                                {categoryIcons[template.category]}
                                <span className="text-sm">
                                  {TEMPLATE_CATEGORY_LABELS[template.category]}
                                </span>
                              </div>
                            </TableCell>
                            <TableCell>
                              <Badge
                                variant="secondary"
                                className={cn('text-xs', severityBadgeStyles[template.severity])}
                              >
                                {FINDING_SEVERITY_LABELS[template.severity]}
                              </Badge>
                            </TableCell>
                            <TableCell>
                              {template.cweId ? (
                                <Badge variant="outline" className="font-mono text-xs">
                                  {template.cweId}
                                </Badge>
                              ) : (
                                <span className="text-muted-foreground text-sm">-</span>
                              )}
                            </TableCell>
                            <TableCell>
                              {template.isBuiltIn ? (
                                <div className="flex items-center gap-1 text-yellow-600 dark:text-yellow-500">
                                  <Star className="h-3.5 w-3.5" />
                                  <span className="text-xs">Built-in</span>
                                </div>
                              ) : (
                                <span className="text-xs text-muted-foreground">Custom</span>
                              )}
                            </TableCell>
                            <TableCell className="text-right">
                              <span className="text-sm tabular-nums">{template.usageCount}</span>
                            </TableCell>
                            <TableCell onClick={(e) => e.stopPropagation()}>
                              <DropdownMenu>
                                <DropdownMenuTrigger asChild>
                                  <Button variant="ghost" size="icon" className="h-8 w-8">
                                    <MoreHorizontal className="h-4 w-4" />
                                  </Button>
                                </DropdownMenuTrigger>
                                <DropdownMenuContent align="end">
                                  <DropdownMenuItem onClick={() => handleView(template)}>
                                    <Eye className="h-4 w-4 mr-2" />
                                    View
                                  </DropdownMenuItem>
                                  <DropdownMenuItem onClick={() => handleDuplicate(template)}>
                                    <Copy className="h-4 w-4 mr-2" />
                                    Duplicate
                                  </DropdownMenuItem>
                                  {!template.isBuiltIn && (
                                    <>
                                      <DropdownMenuItem onClick={() => handleEdit(template)}>
                                        <Edit2 className="h-4 w-4 mr-2" />
                                        Edit
                                      </DropdownMenuItem>
                                      <DropdownMenuSeparator />
                                      <DropdownMenuItem
                                        className="text-destructive focus:text-destructive"
                                        onClick={() => handleDelete(template)}
                                      >
                                        <Trash2 className="h-4 w-4 mr-2" />
                                        Delete
                                      </DropdownMenuItem>
                                    </>
                                  )}
                                </DropdownMenuContent>
                              </DropdownMenu>
                            </TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </div>

                  {/* Pagination */}
                  <div className="flex flex-col sm:flex-row items-center justify-between gap-3 px-4 py-3 border-t">
                    <div className="flex items-center gap-2 text-sm text-muted-foreground">
                      <span>
                        {startIndex + 1}-
                        {Math.min(startIndex + pageSize, filteredAndSortedTemplates.length)} of{' '}
                        {filteredAndSortedTemplates.length}
                      </span>
                      <Select
                        value={pageSize.toString()}
                        onValueChange={(v) => {
                          setPageSize(Number(v))
                          setCurrentPage(1)
                        }}
                      >
                        <SelectTrigger className="w-[70px] h-8">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          {PAGE_SIZE_OPTIONS.map((size) => (
                            <SelectItem key={size} value={size.toString()}>
                              {size}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <span>per page</span>
                    </div>
                    <div className="flex items-center gap-1">
                      <Button
                        variant="outline"
                        size="icon"
                        className="h-8 w-8"
                        onClick={() => setCurrentPage(1)}
                        disabled={currentPage === 1}
                      >
                        <ChevronsLeft className="h-4 w-4" />
                      </Button>
                      <Button
                        variant="outline"
                        size="icon"
                        className="h-8 w-8"
                        onClick={() => setCurrentPage((p) => Math.max(1, p - 1))}
                        disabled={currentPage === 1}
                      >
                        <ChevronLeft className="h-4 w-4" />
                      </Button>
                      <span className="text-sm px-3 tabular-nums">
                        {currentPage} / {totalPages || 1}
                      </span>
                      <Button
                        variant="outline"
                        size="icon"
                        className="h-8 w-8"
                        onClick={() => setCurrentPage((p) => Math.min(totalPages, p + 1))}
                        disabled={currentPage === totalPages || totalPages === 0}
                      >
                        <ChevronRight className="h-4 w-4" />
                      </Button>
                      <Button
                        variant="outline"
                        size="icon"
                        className="h-8 w-8"
                        onClick={() => setCurrentPage(totalPages)}
                        disabled={currentPage === totalPages || totalPages === 0}
                      >
                        <ChevronsRight className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ) : (
              /* Grid View */
              <>
                <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                  {paginatedTemplates.map((template) => (
                    <Card
                      key={template.id}
                      className={cn(
                        'group cursor-pointer hover:shadow-md transition-all overflow-hidden',
                        selectedIds.has(template.id) && 'ring-2 ring-primary'
                      )}
                      onClick={() => handleView(template)}
                    >
                      <div className={cn('h-1', severityColors[template.severity])} />
                      <CardContent className="p-4">
                        <div className="flex items-start justify-between gap-2 mb-2">
                          <div className="flex-1 min-w-0">
                            <h3 className="font-medium text-sm line-clamp-1">{template.name}</h3>
                            <div className="flex items-center gap-1.5 mt-0.5 text-muted-foreground">
                              {categoryIcons[template.category]}
                              <span className="text-xs">
                                {TEMPLATE_CATEGORY_LABELS[template.category]}
                              </span>
                            </div>
                          </div>
                          <div
                            className="flex items-center gap-1"
                            onClick={(e) => e.stopPropagation()}
                          >
                            {template.isBuiltIn && <Star className="h-4 w-4 text-yellow-500" />}
                            <Checkbox
                              checked={selectedIds.has(template.id)}
                              onCheckedChange={(checked) =>
                                handleSelectOne(template.id, checked as boolean)
                              }
                              className="opacity-0 group-hover:opacity-100 transition-opacity"
                            />
                          </div>
                        </div>

                        <p className="text-xs text-muted-foreground line-clamp-2 mb-3 min-h-[32px]">
                          {template.description}
                        </p>

                        <div className="flex items-center justify-between">
                          <div className="flex gap-1.5">
                            <Badge
                              variant="secondary"
                              className={cn('text-xs', severityBadgeStyles[template.severity])}
                            >
                              {FINDING_SEVERITY_LABELS[template.severity]}
                            </Badge>
                            {template.cweId && (
                              <Badge variant="outline" className="text-xs font-mono">
                                {template.cweId}
                              </Badge>
                            )}
                          </div>
                          <span className="text-xs text-muted-foreground tabular-nums">
                            {template.usageCount} uses
                          </span>
                        </div>
                      </CardContent>
                    </Card>
                  ))}
                </div>

                {/* Grid Pagination */}
                {totalPages > 1 && (
                  <div className="flex items-center justify-between px-2">
                    <div className="flex items-center gap-2 text-sm text-muted-foreground">
                      <span>
                        {startIndex + 1}-
                        {Math.min(startIndex + pageSize, filteredAndSortedTemplates.length)} of{' '}
                        {filteredAndSortedTemplates.length}
                      </span>
                    </div>
                    <div className="flex items-center gap-1">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setCurrentPage((p) => Math.max(1, p - 1))}
                        disabled={currentPage === 1}
                      >
                        <ChevronLeft className="h-4 w-4 mr-1" />
                        Previous
                      </Button>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setCurrentPage((p) => Math.min(totalPages, p + 1))}
                        disabled={currentPage === totalPages}
                      >
                        Next
                        <ChevronRight className="h-4 w-4 ml-1" />
                      </Button>
                    </div>
                  </div>
                )}
              </>
            )}

            {/* Template Detail Sheet */}
            <TemplateDetailSheet
              open={detailSheetOpen}
              onOpenChange={setDetailSheetOpen}
              template={selectedTemplate}
              onEdit={handleEdit}
              onDuplicate={handleDuplicate}
            />

            {/* Delete Confirmation Dialog */}
            <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>
              <AlertDialogContent>
                <AlertDialogHeader>
                  <AlertDialogTitle>Delete Template</AlertDialogTitle>
                  <AlertDialogDescription>
                    Are you sure you want to delete &quot;{templateToDelete?.name}&quot;? This
                    action cannot be undone.
                  </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                  <AlertDialogCancel>Cancel</AlertDialogCancel>
                  <AlertDialogAction
                    onClick={confirmDelete}
                    className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                  >
                    Delete
                  </AlertDialogAction>
                </AlertDialogFooter>
              </AlertDialogContent>
            </AlertDialog>
          </div>
        </TooltipProvider>
      </Main>
    </>
  )
}
